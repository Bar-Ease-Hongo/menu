# デプロイ手順

## 新規デプロイ（初回）

初めてWebアプリをデプロイする場合は、以下の手順に従ってください。

### 1. Apps Scriptプロジェクトの準備

1. Googleスプレッドシートを開く
2. `拡張機能` → `Apps Script` を選択
3. `Code.gs` と `index.html` を作成・貼り付け

### 2. 初期設定

1. `Code.gs` で関数選択ドロップダウンから `setupMenuSheet` を選択
2. 実行ボタン ▶️ をクリック
3. 認可ダイアログで権限を付与

### 3. Script Propertiesの設定

1. ⚙️ → `プロジェクトの設定` → `スクリプト プロパティ`
2. `GEMINI_API_KEY` を追加（[Google AI Studio](https://aistudio.google.com/app/apikey)で取得）
3. `SECRET_KEY` は初回QRコード生成時に自動生成されます

### 4. デプロイ

1. 右上の `デプロイ` → `新しいデプロイ` をクリック
2. 種類: `ウェブアプリ` を選択
3. 設定:
   - **説明**: `Bar Ease Hongo メニューアプリ`
   - **次のユーザーとして実行**: `自分`
   - **アクセスできるユーザー**: `全員`
4. `デプロイ` をクリック
5. **WebアプリのURLをコピー**（重要！）

### 5. QRコード生成

1. スプレッドシートに戻る
2. `メニューアプリ` → `QRコード・URL表示` を選択
3. 有効期限を入力（推奨: 7日間）
4. QRコードを印刷して店内に掲示

---

## 更新デプロイ（コード変更時）

コードを変更した後、変更を反映するには**必ず再デプロイ**が必要です。

### 方法1: 新しいバージョンとしてデプロイ（推奨）

1. `デプロイ` → `デプロイを管理` をクリック
2. 現在のデプロイの ✏️（編集）アイコンをクリック
3. 右上の `バージョン` ドロップダウン → `新バージョン` を選択
4. 説明を入力（例: `アクセス制限機能追加`）
5. `デプロイ` をクリック

**注意**: 既存のWebアプリURLは変わりません。

### 方法2: テストデプロイで確認

コードをテストしたい場合：

1. 右上の `テストデプロイ` をクリック
2. `テストを実行` からテスト用URLにアクセス
3. 問題がなければ、上記の「方法1」で本番デプロイ

---

## アクセス制限機能の有効化（今回の更新）

### 既存のWebアプリにアクセス制限を追加する場合

#### Step 1: コードを更新

1. `Code.gs` と `index.html` を最新版に更新
2. 変更内容を保存

#### Step 2: 再デプロイ

1. `デプロイ` → `デプロイを管理`
2. ✏️（編集）→ `新バージョン`
3. 説明: `アクセス制限機能追加 (QRコードベース認証)`
4. `デプロイ` をクリック

#### Step 3: SECRET_KEYの生成

1. スプレッドシートに戻る
2. `メニューアプリ` → `QRコード・URL表示` を選択
3. 初回実行時に秘密鍵を自動生成
4. 「はい」を選択

#### Step 4: QRコード生成と配布

1. 有効期限を入力（推奨: 7日間）
2. QRコードを印刷
3. 店内に掲示

#### ⚠️ 重要: 既存URLへの影響

再デプロイ後、**既存のWebアプリURLは全てアクセス制限がかかります**。

- QRコード経由でのみアクセス可能
- 直接URLアクセスは拒否される
- 既存のブックマークやリンクは無効になります

---

## デプロイ後の確認

### 1. アクセステスト

- [ ] QRコードからアクセスできることを確認
- [ ] メニュー一覧が表示されることを確認
- [ ] AIおすすめ機能が動作することを確認

### 2. アクセス制限テスト

- [ ] トークンなしのURLで「アクセスが制限されています」と表示されることを確認
- [ ] 有効期限切れのトークンで「QRコードの有効期限が切れています」と表示されることを確認

### 3. エラーログ確認

1. Apps Scriptエディタで `表示` → `ログ`
2. エラーが出ていないことを確認

---

## トラブルシューティング

### 「認可が必要です」というエラーが出る

**原因**: 新しい権限が必要

**対処法**:
1. `Code.gs` で任意の関数を実行
2. 認可ダイアログで権限を付与
3. 再度デプロイ

### 変更が反映されない

**原因**: キャッシュが残っている、または再デプロイが必要

**対処法**:
1. ブラウザのキャッシュをクリア（Ctrl+Shift+R / Cmd+Shift+R）
2. `デプロイを管理` から新バージョンでデプロイ
3. 5分ほど待ってから再度アクセス

### QRコード生成でエラーが出る

**原因**: SECRET_KEYが未設定

**対処法**:
1. 初回セットアップダイアログで「はい」を選択
2. Script Propertiesで `SECRET_KEY` が設定されていることを確認

---

## デプロイ履歴の管理

### バージョン管理のベストプラクティス

各デプロイには説明を付けることを推奨：

| バージョン | 説明 | 日付 |
|----------|------|------|
| v1 | 初期リリース | 2025-10-11 |
| v2 | キャッシュ機能追加 | 2025-10-15 |
| v3 | アクセス制限機能追加 | 2025-10-18 |

### ロールバック方法

問題が発生した場合、以前のバージョンに戻すことができます：

1. `デプロイ` → `デプロイを管理`
2. 戻したいバージョンの ✏️（編集）をクリック
3. `デプロイ` をクリック

---

## 本番環境チェックリスト

デプロイ前に以下を確認してください：

- [ ] `Code.gs` と `index.html` が最新版
- [ ] `GEMINI_API_KEY` が設定されている
- [ ] `setupMenuSheet` を実行済み
- [ ] テストデプロイで動作確認済み
- [ ] QRコードを生成済み（アクセス制限機能使用の場合）
- [ ] エラーログに問題がない
- [ ] 本番デプロイ実行
- [ ] 本番環境で動作確認

---

## サポート

デプロイに問題がある場合は、以下の情報を添えて開発チームに連絡してください：

- Apps Scriptのログ（`表示` → `ログ`）
- エラーメッセージのスクリーンショット
- デプロイの設定内容
- Script Propertiesの設定状況（APIキーは除く）

---

**最終更新**: 2025-10-18  
**バージョン**: v1.0

