# アクセス制限機能 - QRコードベース認証

## 概要

Bar Ease HongoのWebアプリは、**QRコードベースのTTL（Time To Live）付きトークン認証**により、不正アクセスを防止しています。

### 仕組み

1. **トークン生成**: HMAC-SHA256署名を使用した安全なトークンを生成
2. **有効期限設定**: トークンに有効期限（デフォルト7日間）を設定
3. **QRコード作成**: トークン付きURLをQRコードに変換
4. **アクセス時検証**: Webアプリへのアクセスごとにトークンと有効期限を検証

### セキュリティ

- **改ざん防止**: HMAC-SHA256署名により、トークンの改ざんを検知
- **時間制限**: 有効期限が切れたQRコードは自動的に無効化
- **秘密鍵管理**: Script Propertiesで安全に保管（暗号化済み）

---

## QRコード生成手順

### 1. スプレッドシートから生成

1. Googleスプレッドシートを開く
2. メニューバーから `メニューアプリ` → `QRコード・URL表示` を選択
3. 有効期限（日数）を入力
   - 例: `7` （7日間有効）
   - 範囲: 1〜365日
4. 「OK」をクリック

### 2. ダイアログの内容

表示されるダイアログには以下が含まれます：

- **QRコード画像**: 印刷可能な300x300pxの画像
- **URL**: トークン付きの完全なURL
- **有効期限**: 設定した日数
- **URLコピーボタン**: ワンクリックでクリップボードにコピー

### 3. QRコードの印刷と掲示

1. ダイアログ内のQRコード画像を右クリック → `名前を付けて画像を保存`
2. 画像を印刷（推奨サイズ: A5以上）
3. 店内の見やすい場所に掲示
   - テーブル上
   - カウンター横
   - 入口付近

---

## 初回セットアップ

### SECRET_KEYの自動生成

初回のQRコード生成時に、以下のダイアログが表示されます：

```
初回セットアップ

アクセストークン用の秘密鍵が設定されていません。

自動的に秘密鍵を生成しますか？
```

**「はい」を選択してください。**

- 256ビットのランダムな秘密鍵が自動生成されます
- Script Propertiesに安全に保存されます
- 以降のQRコード生成では再利用されます

### 手動での確認方法

1. Apps Scriptエディタを開く
2. ⚙️ → `プロジェクトの設定`
3. `スクリプト プロパティ` を確認
4. `SECRET_KEY` が設定されていることを確認

---

## 運用ガイド

### 推奨する有効期限

| 期間 | 用途 | 推奨度 |
|------|------|--------|
| **7日間** | 通常運用（推奨） | ⭐⭐⭐ |
| 3日間 | 短期イベント | ⭐⭐ |
| 14日間 | 長期掲示 | ⭐ |
| 30日間 | テスト用 | ⚠️ |

### QRコード更新タイミング

以下のいずれかのタイミングで更新することを推奨：

1. **定期更新**: 有効期限の1〜2日前
2. **セキュリティ上の懸念**: 不正利用が疑われる場合
3. **メニュー大幅更新**: 大規模なメニュー変更時

### 更新手順

1. 新しいQRコードを生成
2. 新しいQRコードを印刷
3. 店内の古いQRコードを新しいものに差し替え

**注意**: 古いQRコードは有効期限まで使用可能なため、並行期間を設けることができます。

---

## トラブルシューティング

### 「アクセスが制限されています」と表示される

**原因**: QRコードの有効期限が切れている

**対処法**:
1. 新しいQRコードを生成
2. 有効期限を確認（7日間推奨）
3. 店内のQRコードを更新

### 「無効なQRコードです」と表示される

**原因**: トークンが改ざんされている、または不正なURL

**対処法**:
1. 公式のQRコード生成機能を使用
2. URLを手動で編集しない
3. 正しいQRコードを再度掲示

### QRコード生成時にエラーが出る

**原因**: SECRET_KEYが未設定、またはスクリプトエラー

**対処法**:
1. 初回セットアップダイアログで「はい」を選択
2. Apps Scriptのログを確認: `表示` → `ログ`
3. エラーメッセージを確認して対処

### SECRET_KEYを再生成したい

⚠️ **警告**: SECRET_KEYを再生成すると、既存の全QRコードが無効になります。

**手順**:
1. Apps Scriptエディタ → ⚙️ → `プロジェクトの設定`
2. `スクリプト プロパティ` から `SECRET_KEY` を削除
3. 再度QRコード生成機能を実行
4. 新しいSECRET_KEYが自動生成される
5. **全てのQRコードを再生成・再掲示してください**

---

## 技術詳細

### トークン生成アルゴリズム

```javascript
// メッセージ生成
const message = 'bar-ease-hongo-' + expiresTimestamp;

// HMAC-SHA256署名
const signature = Utilities.computeHmacSha256Signature(message, secretKey);

// Base64エンコード（URLセーフ）
const token = Utilities.base64EncodeWebSafe(signature);
```

### URL構造

```
https://script.google.com/macros/s/{DEPLOYMENT_ID}/exec?token={TOKEN}&expires={TIMESTAMP}
```

- `token`: HMAC-SHA256署名（Base64URLエンコード）
- `expires`: 有効期限のUNIXタイムスタンプ（ミリ秒）

### 検証フロー

```
1. URLパラメータからtokenとexpiresを取得
2. expiresが現在時刻より未来かチェック
3. SECRET_KEYを使ってexpectedTokenを生成
4. tokenとexpectedTokenを比較
5. 一致すればアクセス許可、不一致なら拒否
```

---

## セキュリティのベストプラクティス

### ✅ 推奨

- 有効期限は7日間以内に設定
- 定期的にQRコードを更新（週1回程度）
- SECRET_KEYは絶対に外部に漏らさない
- QRコードを印刷して物理的に管理

### ❌ 非推奨

- 有効期限を30日以上に設定
- URLを手動で編集
- SNSやWebサイトに公開QRコードを掲載
- SECRET_KEYをコードにハードコード

---

## FAQ

### Q1: QRコードを複数生成できますか？

はい、何度でも生成できます。ただし、**同じ有効期限の場合は同じトークンが生成されます**。異なる有効期限で生成すれば、複数のQRコードを並行運用できます。

### Q2: URLを直接共有しても大丈夫ですか？

推奨しません。QRコードは店内でのアクセス用に設計されています。URLを共有すると、有効期限内は誰でもアクセス可能になります。

### Q3: 有効期限を過ぎたQRコードはどうなりますか？

アクセス時に「QRコードの有効期限が切れています」というエラーページが表示されます。新しいQRコードを生成してください。

### Q4: レート制限はありますか？

現在、Gemini APIのレート制限のみが適用されます（10秒間隔）。QRコードによるアクセス制限は、不正利用を防ぐための第一段階の防御です。

### Q5: コストはかかりますか？

QRコード生成機能自体は無料です。ただし、Gemini APIの使用には通常のコストがかかります。

---

**最終更新**: 2025-10-18  
**バージョン**: v1.0

