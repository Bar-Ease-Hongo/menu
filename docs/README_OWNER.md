# Bar Ease Hongo オーナー向け運用ガイド

このドキュメントは、**GAS完結版**の運用手順を説明します。

---

## 📋 目次

1. [概要](#概要)
2. [初期設定](#初期設定)
3. [日常運用](#日常運用)
4. [メニュー反映フロー](#メニュー反映フロー)
5. [トラブルシューティング](#トラブルシューティング)
6. [旧AWS構成の再起動](#旧aws構成の再起動)

---

## 概要

### 現行システム構成（GAS完結版）

- **Googleスプレッドシート**: メニュー管理画面（SSOT）
- **Google Apps Script (GAS)**: Webアプリ＋AI機能
- **Gemini 2.0 Flash Experimental**: AIおすすめ＋AI補完エンジン
- **GitHub**: ソースコード管理

### 主な機能

✅ **メニュー一覧表示**  
Webアプリで承認済み商品を表示（~1000件を即時配信）

✅ **クライアント検索**  
ブラウザ内で検索/絞込/ソート（サーバー負荷なし）

✅ **AI補完**  
Gemini 2.0 Flash Expで商品情報を自動補完（公式情報優先、欠損値のみ、最大10件のバッチ処理）

✅ **AIおすすめ**  
Gemini 2.0 Flash Expで再ランク＋理由生成（80〜120字）

✅ **リアルタイム反映**  
ブラウザリロードで即座に最新データを表示

---

## 初期設定

### 1. Googleスプレッドシート準備

1. メニュー管理用のスプレッドシートを開く
2. シート名を「**メニュー**」に変更（必須）
3. 既存の商品データがある場合はそのまま残す

### 2. Apps Script プロジェクト作成

1. スプレッドシートで `拡張機能` → `Apps Script` を選択
2. 新規プロジェクトが開いたら、デフォルトの `Code.gs` を削除
3. 新規ファイル `Code.gs` を作成し、`apps-script/Code.gs` の内容を貼り付け
4. 新規HTML ファイル `index` を作成し、`apps-script/index.html` の内容を貼り付け
5. プロジェクト名を「**Bar Ease Hongo**」に変更
6. 保存（Ctrl+S / Cmd+S）

### 3. Gemini APIキーの取得と設定

#### 3-1. APIキーの取得方法

1. [Google AI Studio](https://aistudio.google.com/app/apikey) にアクセス
2. Googleアカウントでログイン（スプレッドシートと同じアカウントを推奨）
3. 「**APIキーを取得**」または「**Create API Key**」ボタンをクリック
4. 新しいプロジェクトを作成するか、既存のプロジェクトを選択
5. 生成されたAPIキーをコピー（このキーは後で確認できないため、必ず保存してください）

**重要な注意事項：**
- APIキーは外部に漏らさないでください
- APIキーはパスワードと同じように大切に管理してください
- 無料枠の範囲内で利用できますが、大量のリクエストには制限があります
- 使用モデル: **Gemini 2.0 Flash Experimental**（高速・安定・低コスト）

#### 3-2. Apps ScriptへのAPIキー設定

1. Apps Script エディタで画面左側の歯車アイコン ⚙️（プロジェクトの設定）をクリック
2. 下にスクロールして「**スクリプト プロパティ**」セクションを探す
3. 「**スクリプト プロパティを追加**」をクリック
4. 以下の情報を入力：
   - **プロパティ**: `GEMINI_API_KEY`（半角英数字で正確に入力）
   - **値**: 先ほどコピーしたAPIキーを貼り付け
5. 「**スクリプト プロパティを保存**」をクリック

**設定の確認：**
- プロパティ名が `GEMINI_API_KEY` であることを確認（大文字・小文字を正確に）
- 値にAPIキーが正しく入力されていることを確認

### 4. 初期セットアップ実行

スプレッドシートに必要な列を追加し、システムを使用可能な状態にします。

1. スプレッドシートをリロード（F5キー または ブラウザの更新ボタン）
2. 上部メニューに「**メニューアプリ**」というメニューが表示されるまで待つ（数秒かかる場合があります）
3. 「**メニューアプリ**」→「**初期設定**」をクリック
4. 初回実行時に認可ダイアログが表示される場合：
   - 「**権限を確認**」または「**続行**」をクリック
   - Googleアカウントを選択
   - 「**詳細**」→「**Bar Ease Hongo（安全ではないページ）に移動**」をクリック
   - 「**許可**」をクリック
5. 「**セットアップ完了**」というダイアログが表示されればOK

**実行結果：**

スプレッドシートに以下の列が自動的に追加されます：

| 列名 | 説明 | 編集 |
|------|------|------|
| `公開カテゴリ` | 酒種（ウイスキー、ラム、ジン等） | ✅ 手動編集可 |
| `公開国` | 生産国 | ✅ 手動編集可 |
| `公開メーカー` | メーカー名 | ✅ 手動編集可 |
| `公開蒸溜所` | 蒸溜所名 | ✅ 手動編集可 |
| `公開タイプ` | 酒種内の分類（シングルモルト等） | ✅ 手動編集可 |
| `公開商品名` | 商品名 | ✅ 手動編集可 |
| `公開説明文` | 商品説明（50〜80文字） | ✅ 手動編集可 |
| `公開樽種` | 樽種・熟成容器 | ✅ 手動編集可 |
| `公開熟成期間` | 熟成年数・期間 | ✅ 手動編集可 |
| `公開度数` | アルコール度数 | ✅ 手動編集可 |
| `公開タグ` | 味わい・特徴タグ（カンマ区切り） | ✅ 手動編集可 |
| `AI補完状態` | AI補完の実行状態 | ⚠️ システム管理（編集注意） |
| `メニュー表示状態` | メニュー表示/非表示 | ⚠️ システム管理（編集注意） |

**列の役割：**
- **公開列**：Webアプリに表示される情報。手動編集またはAI補完で設定
- **元列**（商品名、製造会社等）：バックアップデータとして維持。公開列が空の場合のフォールバック
- **システム管理列**：自動的に更新される列。手動編集は推奨しません

### 5. Web アプリとして公開

1. Apps Script エディタで `デプロイ` → `新しいデプロイ` を選択
2. 種類の選択で ⚙️ → `ウェブアプリ` を選択
3. 設定:
   - **説明**: `Bar Ease Hongo メニュー`
   - **次のユーザーとして実行**: `自分（あなたのメールアドレス）`
   - **アクセスできるユーザー**: `全員`
4. `デプロイ` をクリック
5. **WebアプリのURL** をコピーして保存（後で使用）

**例**: `https://script.google.com/macros/s/AKfycby.../exec`

### 6. 動作確認

1. コピーしたWebアプリのURLをブラウザで開く
2. 「Bar Ease Hongo メニュー」ページが表示されればOK
3. カテゴリを選択してメニュー一覧タブで商品が表示されることを確認
4. AIおすすめタブで「おすすめを表示」をクリックして動作確認

---

## 日常運用

### 新規商品の追加

#### 基本フロー

1. スプレッドシートの「メニュー」シートを開く
2. 新しい行に商品情報を入力:
   - 必須: `商品名`, `製造会社`, `度数`, `30ml` (価格)
   - 任意: その他の情報
3. 保存

#### オプション1: 手動で公開列を入力

4. `公開商品名`, `公開メーカー`, `公開カテゴリ` 等の公開列を手動で入力
5. 対象の行を選択（複数行選択可）
6. 上部メニュー `メニューアプリ` → `メニューに表示` を選択
7. 確認ダイアログで `はい` をクリック

**結果**: Webアプリをリロード（F5）すると、メニューに表示される

**ヒント**: Shiftキーを押しながら行を選択すると、複数行を一括処理できます

#### オプション2: AIで自動補完（推奨）

4. 対象行を選択（**最大10行まで一度に選択可能**）
5. 上部メニュー `メニューアプリ` → `AI補完を実行 (最大10件)` を選択
6. 確認ダイアログで処理内容を確認し `はい` をクリック
7. 10〜60秒待つと、公開列に自動補完された情報が反映される
   - 1件の場合: 約10〜30秒
   - 複数件の場合: 約30〜60秒
8. 内容を確認・必要なら修正
9. 対象の行を選択（複数行選択可）
10. 上部メニュー `メニューアプリ` → `メニューに表示` を選択

**AI補完の特徴：**
- 公式情報（メーカー公式サイト、正規輸入元等）を最優先に補完
- 欠損値または明らかに間違っている情報のみを補完・修正
- 商品説明、タグ、カテゴリ、タイプ、国、度数等を自動生成
- 既存値が正確な場合は変更しない
- **複数行を一度に処理可能（最大10件）**

**注意**: 
- 処理中はスプレッドシートを編集しないでください
- AI補完後、`AI補完状態` 列に「成功」または「失敗」が表示されます
- 11件以上選択した場合はエラーメッセージが表示されます

### 商品情報の更新

1. 既存商品の行を編集
2. **公開列** (`公開商品名`, `公開メーカー` 等) を編集すると `メニュー表示状態` が自動的にクリアされる
3. 編集後、再度 上部メニュー `メニューアプリ` → `メニューに表示` を実行する必要がある

**自動クリアの理由**: 
- 商品情報が変更されたことを明示的に管理するため
- 意図しない古い情報の表示を防ぐため

### 商品の非表示

1. 非表示にしたい商品の行を選択（複数行選択可）
2. 上部メニュー `メニューアプリ` → `メニューから非表示` を選択
3. 確認ダイアログで `はい` をクリック

**結果**: Webアプリをリロード（F5）すると、メニューから削除される

**ヒント**: 複数の商品を一括で非表示にする場合、Shiftキーを押しながら範囲選択してください

---

## メニュー反映フロー

### 反映の仕組み

- **CacheService**で高速化（10分間キャッシュ）
  - 初回アクセス: スプレッドシートから取得（2〜3秒）
  - 2回目以降: キャッシュから返却（**0.1秒以下**）
- データ更新時に自動的にキャッシュクリア
- **時間トリガー不要**（リアルタイムデータ取得）

### キャッシュクリアのタイミング

以下の操作で自動的にキャッシュがクリアされます：

- ✅ 「メニューに表示」実行時
- ✅ 「メニューから非表示」実行時
- ✅ 「AI補完を実行」完了時
- ✅ 公開列（`公開商品名`, `公開メーカー` 等）の手動編集時

### 反映手順

1. スプレッドシートで「メニューに表示」または「メニューから非表示」を実行
2. キャッシュが自動的にクリアされる
3. Webアプリのページで **F5** または **Ctrl+R / Cmd+R** でリロード
4. 最新のメニューが表示される（キャッシュ再生成）

**注意**: 
- スプレッドシートで編集後、必ずWebアプリをリロードしてください
- リロードしないと、古いキャッシュが表示される可能性があります

---

## トラブルシューティング

### 問題: メニューに商品が表示されない

**原因**:
- `メニュー表示状態` が空または「非表示」
- `公開カテゴリ` が未設定

**対処**:
1. スプレッドシートで対象行の `メニュー表示状態` を確認
2. 「メニューに表示」になっていない場合は、上部メニュー `メニューアプリ` → `メニューに表示` を実行
3. `公開カテゴリ` が設定されているか確認（未設定の場合は「その他」として表示されます）
4. Webアプリをリロード（F5）

### 問題: 「メニューアプリ」メニューが表示されない

**原因**:
- スプレッドシートが完全に読み込まれていない
- Apps Scriptが正しくデプロイされていない

**対処**:
1. スプレッドシートをリロード（F5）して数秒待つ
2. 上部メニューに「メニューアプリ」が表示されるか確認
3. 表示されない場合は、Apps Script エディタで `Code.gs` の `onOpen` 関数を手動で実行
4. それでも表示されない場合は、Apps Scriptの権限を再確認

### 問題: AIおすすめが動作しない

**原因**:
- `GEMINI_API_KEY` が未設定または無効
- APIクォータを超過
- カテゴリが未選択

**対処**:
1. Apps Script エディタで ⚙️ → `プロジェクトの設定` を開く
2. `スクリプト プロパティ` に `GEMINI_API_KEY` が設定されているか確認
3. 未設定の場合は、[Google AI Studio](https://aistudio.google.com/app/apikey) で新しいキーを取得して設定
4. Webアプリでカテゴリを選択しているか確認
5. 少し時間を置いてから再試行

### 問題: 「GEMINI_API_KEYが設定されていません」エラー

**対処**:
1. Apps Script エディタで ⚙️ → `プロジェクトの設定` を開く
2. `スクリプト プロパティ` セクションで `GEMINI_API_KEY` を追加
3. 値に [Google AI Studio](https://aistudio.google.com/app/apikey) で取得したAPIキーを貼り付け
4. 保存後、スプレッドシートをリロードして再試行

### 問題: AI補完が失敗する

**原因**:
- Gemini APIのレート制限（短時間に大量のリクエスト）
- APIキーが無効
- ネットワークエラー
- 処理中にスプレッドシートを編集した

**対処**:
1. 少し時間を置いてから再試行（5〜10分程度）
2. 一度に処理する件数を減らす（10件 → 5件等）
3. APIキーが有効か確認（[Google AI Studio](https://aistudio.google.com/app/apikey)）
4. Apps Scriptの実行ログを確認（Apps Script エディタで `実行数` をクリック）
5. エラーメッセージをコピーして開発チームに連絡

### 問題: AI補完結果が期待と異なる

**対処**:
1. 公開列を手動で修正可能（AI補完は参考情報として使用）
2. `AI補完状態` が「成功」になっていれば正常に完了している
3. 再度AI補完を実行することも可能（既存の値を上書き）
4. 特定の項目のみ手動修正することを推奨

### 問題: メニューが更新されない

**原因**:
- Webアプリをリロードしていない
- キャッシュが残っている
- メニュー表示状態が正しく設定されていない

**対処**:
1. Webアプリのページで **F5** または **Ctrl+R / Cmd+R** でリロード
2. スプレッドシートの「メニュー表示状態」が「メニューに表示」になっているか確認
3. ブラウザのキャッシュをクリア（Ctrl+Shift+Delete / Cmd+Shift+Delete）
4. 別のブラウザで試してみる

### 問題: Webアプリが表示されない

**原因**:
- デプロイが正しく完了していない
- URLが間違っている
- アクセス権限の設定が不適切

**対処**:
1. Apps Script エディタで `デプロイ` → `デプロイを管理` を開く
2. 最新のデプロイが有効になっているか確認
3. 「アクセスできるユーザー」が「全員」になっているか確認
4. WebアプリのURLを再コピーして試行
5. ブラウザのキャッシュをクリア
6. シークレットモード（プライベートブラウジング）で試してみる

### 問題: 「11件以上選択した場合はエラー」が表示される

**原因**:
- AI補完の最大処理件数を超えている

**対処**:
1. 選択行数を10件以下に減らす
2. 複数回に分けて処理を実行
3. 処理時間が長くなる場合は、さらに少ない件数（5件程度）に分ける

---

**最終更新**: 2025-10-18

