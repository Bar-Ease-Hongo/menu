# Bar Ease Hongo オーナー向け運用ガイド

このドキュメントは、**GAS完結版**の運用手順を説明します。

---

## 📋 目次

1. [概要](#概要)
2. [初期設定](#初期設定)
3. [日常運用](#日常運用)
4. [メニュー反映フロー](#メニュー反映フロー)
5. [トラブルシューティング](#トラブルシューティング)
6. [旧AWS構成の再起動](#旧aws構成の再起動)

---

## 概要

### 現行システム構成（GAS完結版）

- **Googleスプレッドシート**: メニュー管理画面（SSOT）
- **Google Apps Script (GAS)**: Webアプリ＋AI機能
- **Gemini 2.0 Flash Experimental**: AIおすすめ＋AI補完エンジン
- **GitHub**: ソースコード管理

### 主な機能

✅ **メニュー一覧表示**  
Webアプリで承認済み商品を表示（~1000件を即時配信）

✅ **クライアント検索**  
ブラウザ内で検索/絞込/ソート（サーバー負荷なし）

✅ **AI補完**  
Gemini 2.0 Flash Expで商品情報を自動補完（公式情報優先、欠損値のみ）

✅ **AIおすすめ**  
Gemini 2.0 Flash Expで再ランク＋理由生成（80〜120字）

✅ **リアルタイム反映**  
ブラウザリロードで即座に最新データを表示

---

## 初期設定

### 1. Googleスプレッドシート準備

1. メニュー管理用のスプレッドシートを開く
2. シート名を「**メニュー**」に変更（必須）
3. 既存の商品データがある場合はそのまま残す

### 2. Apps Script プロジェクト作成

1. スプレッドシートで `拡張機能` → `Apps Script` を選択
2. 新規プロジェクトが開いたら、デフォルトの `Code.gs` を削除
3. 新規ファイル `Code.gs` を作成し、`apps-script/Code.gs` の内容を貼り付け
4. 新規HTML ファイル `index` を作成し、`apps-script/index.html` の内容を貼り付け
5. プロジェクト名を「**Bar Ease Hongo**」に変更
6. 保存（Ctrl+S / Cmd+S）

### 3. スクリプト プロパティ設定

1. Apps Script エディタで歯車アイコン ⚙️ → `プロジェクトの設定` を開く
2. `スクリプト プロパティ` セクションで以下を追加：

| プロパティ名 | 値 | 取得方法 |
|-------------|-----|---------|
| `GEMINI_API_KEY` | `your-api-key` | [Google AI Studio](https://aistudio.google.com/app/apikey) で取得 |

**注意**: 
- APIキーは絶対に外部に漏らさないでください
- 使用モデル: **Gemini 2.0 Flash Experimental**（高速・安定）

### 4. 初期セットアップ実行

1. `Code.gs` を開く
2. 関数選択ドロップダウンから `setupMenuSheet` を選択
3. 実行ボタン ▶️ をクリック
4. 初回実行時に認可ダイアログが表示される → `続行` → Google アカウント選択 → `許可`
5. 実行ログに「セットアップ完了」と表示されればOK

**実行結果**:
- スプレッドシートに以下の列が追加される:
  - `公開商品名`, `公開メーカー`, `公開カテゴリ`, `公開タグ`, `公開説明文`, `公開度数`
  - `AI補完状態`, `メニュー表示状態`, `ID`, `更新日時`
- 既存行に `ID` (UUID) が自動採番される
- 保護列（`AI補完状態`, `メニュー表示状態`, `ID`, `更新日時`）が設定される

**注意**: `公開画像URL` 列は著作権問題により削除されました。

### 5. Web アプリとして公開

1. Apps Script エディタで `デプロイ` → `新しいデプロイ` を選択
2. 種類の選択で ⚙️ → `ウェブアプリ` を選択
3. 設定:
   - **説明**: `Bar Ease Hongo メニュー`
   - **次のユーザーとして実行**: `自分（あなたのメールアドレス）`
   - **アクセスできるユーザー**: `全員` または `Googleアカウントを持つすべてのユーザー`
4. `デプロイ` をクリック
5. **WebアプリのURL** をコピーして保存（後で使用）

**例**: `https://script.google.com/macros/s/AKfycby.../exec`

### 6. 動作確認

1. コピーしたWebアプリのURLをブラウザで開く
2. 「Bar Ease Hongo メニュー」ページが表示されればOK
3. メニュー一覧タブで商品が表示されることを確認
4. AIおすすめタブで「おすすめを表示」をクリックして動作確認

---

## 日常運用

### 新規商品の追加

#### 基本フロー

1. スプレッドシートの「メニュー」シートを開く
2. 新しい行に商品情報を入力:
   - 必須: `商品名`, `製造会社`, `度数`, `30ml` (価格)
   - 任意: その他の情報
3. 保存すると自動的に `ID` が採番される

#### オプション1: 手動で公開列を入力

4. `公開商品名`, `公開メーカー` 等の公開列を手動で入力
5. 対象の行を選択（複数行選択可）
6. カスタムメニュー `Bar Ease Hongo` → `メニューに表示` を選択
7. 確認ダイアログで `はい` をクリック

**結果**: Webアプリをリロード（F5）すると、メニューに表示される

**ヒント**: Shiftキーを押しながら行を選択すると、複数行を一括処理できます

#### オプション2: AIで自動補完

4. 対象行を選択
5. カスタムメニュー `Bar Ease Hongo` → `AI補完を実行 (1行のみ)` を選択
6. 確認ダイアログで `はい` をクリック
7. 10〜30秒待つと、公開列に自動補完された情報が反映される
8. 内容を確認・必要なら修正
9. 対象の行を選択（複数行選択可）
10. カスタムメニュー `Bar Ease Hongo` → `メニューに表示` を選択

**結果**: AI補完により、公式情報に基づいた商品説明・タグ・カテゴリ等が自動生成される

**注意**: AI補完は現在1行ずつのみ対応

### 商品情報の更新

1. 既存商品の行を編集
2. **優先公開列** (`公開商品名` 等) を編集すると `メニュー表示状態` が自動クリアされる
3. 再度 `メニューに表示` を実行する必要がある

### 商品の非表示

1. 非表示にしたい商品の行を選択（複数行選択可）
2. カスタムメニュー `Bar Ease Hongo` → `メニューから非表示` を選択
3. 確認ダイアログで `はい` をクリック

**結果**: Webアプリをリロード（F5）すると、メニューから削除される

**ヒント**: 複数の商品を一括で非表示にする場合、Shiftキーを押しながら範囲選択してください

---

## メニュー反映フロー

### 反映の仕組み

- **CacheService**で高速化（10分間キャッシュ）
  - 初回アクセス: スプレッドシートから取得（2〜3秒）
  - 2回目以降: キャッシュから返却（**0.1秒以下**）
- データ更新時に自動的にキャッシュクリア
- **時間トリガー不要**（リアルタイムデータ取得）

### キャッシュクリアのタイミング

以下の操作で自動的にキャッシュがクリアされます：

- ✅ 「メニューに表示」実行時
- ✅ 「メニューから非表示」実行時
- ✅ 「AI補完を実行」完了時
- ✅ 優先公開列（`公開商品名`等）の手動編集時

### 反映手順

1. スプレッドシートで「メニューに表示」または「メニューから非表示」を実行
2. キャッシュが自動的にクリアされる
3. Webアプリのページで **F5** または **Ctrl+R / Cmd+R** でリロード
4. 最新のメニューが表示される（キャッシュ再生成）

### 手動でキャッシュをクリア

何らかの理由でキャッシュが古い場合：

1. カスタムメニュー `Bar Ease Hongo` → `🔄 キャッシュをクリア`
2. Webアプリをリロード

---

## トラブルシューティング

### 問題: メニューに商品が表示されない

**原因**:
- `メニュー表示状態` が空または「非表示」
- 5分間隔のトリガーがまだ実行されていない

**対処**:
1. スプレッドシートで対象行の `メニュー表示状態` を確認
2. 「メニューに表示」になっていない場合は、カスタムメニューから設定
3. `今すぐ反映` で即時反映

### 問題: AIおすすめが動作しない

**原因**:
- `GEMINI_API_KEY` が未設定または無効
- APIクォータを超過

**対処**:
1. カスタムメニュー `Bar Ease Hongo` → `設定を確認` を実行
2. `GEMINI_API_KEY` が「✓ 設定済み」になっているか確認
3. 未設定の場合は、[Google AI Studio](https://aistudio.google.com/app/apikey) で新しいキーを取得
4. スクリプト プロパティに設定

### 問題: 「GEMINI_API_KEYが設定されていません」エラー

**対処**:
1. Apps Script エディタで ⚙️ → `プロジェクトの設定` を開く
2. `スクリプト プロパティ` に `GEMINI_API_KEY` を追加
3. 値に [Google AI Studio](https://aistudio.google.com/app/apikey) で取得したAPIキーを貼り付け
4. 保存後、再度AIおすすめまたはAI補完を試行

### 問題: AI補完が失敗する

**原因**:
- Gemini APIのレート制限
- APIキーが無効
- ネットワークエラー

**対処**:
1. 少し時間を置いてから再試行
2. APIキーが有効か確認（[Google AI Studio](https://aistudio.google.com/app/apikey)）
3. Apps Scriptの実行ログを確認（`表示` → `ログ`）
4. エラーメッセージをコピーして開発チームに連絡

### 問題: AI補完結果が期待と異なる

**対処**:
1. 公開列を手動で修正可能
2. `AI補完状態` が「成功」になっていれば正常に完了している
3. 再度AI補完を実行することも可能（上書きされる）

### 問題: IDが自動採番されない

**対処**:
1. カスタムメニュー `Bar Ease Hongo` → `初期設定` を再実行
2. 手動で採番する場合は、対象行を選択して `IDを生成 (1行のみ)` を実行

### 問題: メニューが更新されない

**対処**:
1. Webアプリのページで **F5** または **Ctrl+R / Cmd+R** でリロード
2. スプレッドシートの「メニュー表示状態」が正しく設定されているか確認
3. 「🔍 データ確認（デバッグ）」で行のデータを確認

### 問題: Webアプリが表示されない

**対処**:
1. Apps Script エディタで `デプロイ` → `デプロイを管理` を開く
2. 最新のデプロイが有効になっているか確認
3. WebアプリのURLを再コピーして試行
4. ブラウザのキャッシュをクリア

---

## 旧AWS構成の再起動

将来的にAWS構成に戻す必要がある場合の手順:

### 前提条件

- AWSアカウントの認証情報（IAM credentials）
- Node.js 20.16.0 以上
- pnpm 9.12.3 以上

### 手順

1. **リポジトリのクローン**:
   ```bash
   cd /Users/hiroki/Projects/Bar-Ease-Hongo
   ```

2. **Legacy資産の復元**:
   ```bash
   # Next.js フロントエンド
   mv web-legacy/frontend apps/
   
   # インフラ
   mv infra-legacy infra
   
   # Lambda サービス
   mv services-legacy services
   
   # パッケージ
   mv packages-legacy/* packages/
   ```

3. **依存パッケージのインストール**:
   ```bash
   pnpm install
   ```

4. **環境変数の設定**:
   ```bash
   cp .env.example .env
   # .env を編集してAWS関連の環境変数を設定
   ```

5. **インフラのデプロイ**:
   ```bash
   pnpm deploy:sst:prod
   ```

6. **フロントエンドのビルド**:
   ```bash
   pnpm build:frontend
   ```

詳細は `docs/cleanup-notes.md` を参照してください。

---

## サポート

問題が解決しない場合は、以下の情報を添えて開発チームに連絡してください:

- 発生した問題の詳細
- エラーメッセージ（あれば）
- Apps Script の実行ログ（`表示` → `ログ` で確認）
- AI_Logs シートの最新5件

---

**最終更新**: 2025-10-11

