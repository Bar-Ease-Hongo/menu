<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Bar Ease Hongo メニュー</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bar-dark': '#0B0B0D',
            'bar-gold': '#C9A227',
            'bar-gold-light': '#E4C55A',
            'bar-gray': '#D9D9D9',
            'bar-gray-dark': '#2a2a2a',
          },
          fontFamily: {
            'serif': ['Playfair Display', 'serif'],
            'sans': ['Noto Sans JP', 'system-ui', 'sans-serif'],
          },
          fontSize: {
            'xxl': '1.75rem',
            'xxxl': '2rem',
          }
        }
      }
    }
  </script>
  <style>
    html {
      font-size: 18px;
    }
    
    body {
      font-family: 'Noto Sans JP', system-ui, sans-serif;
    }
    
    /* スクロールバー */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #C9A227;
      border-radius: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-spin-custom {
      animation: spin 1s linear infinite;
    }
    
    /* 複数選択ドロップダウンのスタイル */
    select[multiple] option {
      padding: 12px;
      border-radius: 4px;
      margin: 2px 0;
    }
    
    select[multiple] option:checked {
      background: linear-gradient(#C9A227, #C9A227);
      color: #0B0B0D;
      font-weight: 600;
    }
    
    @media screen and (max-width: 1023px) {
      select[multiple] option {
        padding: 16px;
      }
    }
    
    /* iOS Safariでのズーム防止 */
    @media screen and (max-width: 767px) {
      input, select, textarea {
        font-size: 18px !important;
      }
    }
  </style>
</head>
<body class="bg-bar-dark text-gray-100 overflow-x-hidden">
  <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8">
    <!-- ヘッダー -->
    <header class="mb-6 sm:mb-8 py-6 sm:py-8 border-b border-bar-gray-dark">
      <h1 class="text-6xl sm:text-6xl lg:text-5xl text-bar-gold font-serif font-black lg:font-bold mb-4 lg:mb-2">Bar Ease Hongo</h1>
      <p class="text-2xl sm:text-3xl lg:text-base text-bar-gray font-medium">心に残る一杯との出会いを。</p>
    </header>
    
    <!-- カテゴリ選択（共通） -->
    <div class="mb-6 sm:mb-8">
      <h2 class="text-2xl sm:text-3xl lg:text-base text-bar-gray mb-4 lg:mb-3 font-bold lg:font-semibold">カテゴリ</h2>
      <div id="category-buttons" class="flex flex-wrap gap-3 lg:gap-2">
        <!-- カテゴリボタンは動的に生成 -->
      </div>
    </div>
    
    <!-- タブ -->
    <div id="main-tabs" class="hidden flex gap-4 sm:gap-5 lg:gap-3 mb-6 sm:mb-8 border-b-2 border-bar-gray-dark overflow-x-auto">
      <button class="tab-btn px-7 sm:px-8 lg:px-6 py-5 lg:py-3 text-2xl sm:text-3xl lg:text-base text-bar-gray border-b-2 border-transparent transition-all duration-300 hover:text-bar-gold whitespace-nowrap font-bold lg:font-semibold" 
              data-tab="menu">メニュー一覧</button>
      <button class="tab-btn px-7 sm:px-8 lg:px-6 py-5 lg:py-3 text-2xl sm:text-3xl lg:text-base text-bar-gray border-b-2 border-transparent transition-all duration-300 hover:text-bar-gold whitespace-nowrap font-bold lg:font-semibold" 
              data-tab="recommend">おすすめ</button>
    </div>
    
    <!-- データ読み込み中の表示 -->
    <div id="tab-loading" class="hidden flex flex-col items-center justify-center py-24 lg:py-12 text-gray-500">
      <div class="border-[5px] lg:border-4 border-bar-gray-dark border-t-bar-gold rounded-full w-24 lg:w-12 h-24 lg:h-12 animate-spin-custom mb-8 lg:mb-4"></div>
      <p class="text-3xl sm:text-4xl lg:text-base font-medium">データを読み込んでいます...</p>
    </div>
    
    <!-- メニュー一覧タブ -->
    <div id="menu-tab" class="tab-content">
      <!-- 検索フィルタ（カテゴリ選択後に表示） -->
      <div id="search-filters" class="hidden bg-black/40 border border-bar-gray-dark rounded-xl p-6 sm:p-7 lg:p-5 mb-6 sm:mb-8 backdrop-blur-sm">
        <div class="space-y-6 lg:space-y-4">
          <div>
            <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">タイプ</label>
            <select id="type-select" 
                    class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base
                           focus:outline-none focus:border-bar-gold transition-colors">
              <option value="">すべて</option>
            </select>
          </div>
          <div>
            <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">メーカー</label>
            <select id="maker-select" 
                    class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base
                           focus:outline-none focus:border-bar-gold transition-colors">
              <option value="">すべて</option>
            </select>
          </div>
          <div>
            <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">キーワード検索</label>
            <input type="text" id="keyword-input" 
                   class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base
                          focus:outline-none focus:border-bar-gold transition-colors"
                   placeholder="商品名、メーカー、説明文で検索...">
          </div>
          <div id="menu-tag-filter-container">
            <!-- タグフィルタは動的に生成 -->
          </div>
          <div class="flex gap-3 lg:gap-2">
            <button id="search-btn" class="flex-1 px-7 sm:px-8 lg:px-6 py-6 lg:py-3 bg-bar-gold border-[3px] lg:border-2 border-bar-gold rounded-full text-bar-dark text-3xl sm:text-4xl lg:text-base font-black lg:font-semibold
                           transition-all duration-300 hover:bg-transparent hover:text-bar-gold">
              検索
            </button>
            <button id="reset-btn" class="px-7 sm:px-8 lg:px-6 py-6 lg:py-3 bg-transparent border-[3px] lg:border-2 border-neutral-700 rounded-full text-bar-gray text-2xl sm:text-3xl lg:text-sm font-bold lg:font-medium
                           transition-all duration-300 hover:border-bar-gold hover:text-bar-gold">
              リセット
            </button>
          </div>
        </div>
      </div>
      
      <div id="menu-count" class="text-2xl sm:text-3xl lg:text-base text-bar-gray mb-6 font-bold lg:font-medium"></div>
      <div id="menu-grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-5 sm:gap-6 mb-8"></div>
    </div>
    
    <!-- おすすめタブ -->
    <div id="recommend-tab" class="tab-content hidden">
      <!-- おすすめフォーム（カテゴリ選択後に表示） -->
      <div id="recommend-form" class="hidden bg-black/40 border border-bar-gray-dark rounded-xl p-6 sm:p-7 lg:p-5 mb-6 sm:mb-8 backdrop-blur-sm">
        <div class="space-y-6 lg:space-y-4">
          <div>
            <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">気分や好みを自由に入力</label>
            <textarea id="recommend-text" 
                      class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base
                             focus:outline-none focus:border-bar-gold transition-colors resize-y min-h-[180px] lg:min-h-[100px]"
                      placeholder="例: スモーキーでフルーティー、甘さ控えめのものが飲みたい"></textarea>
          </div>
          
          <!-- クイックフィルタ -->
          <div>
            <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">クイックフィルタ</label>
            <div class="space-y-6 lg:space-y-4">
              <!-- 香り -->
              <div>
                <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">香り（Aroma / Nose）</label>
                <select id="aroma-select" 
                        class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base
                               focus:outline-none focus:border-bar-gold transition-colors">
                  <!-- オプションは動的に生成 -->
                </select>
              </div>
              
              <!-- 味わい -->
              <div>
                <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">味わい（Palate / Taste）</label>
                <select id="taste-select" 
                        class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base
                               focus:outline-none focus:border-bar-gold transition-colors">
                  <!-- オプションは動的に生成 -->
                </select>
              </div>
            </div>
          </div>
          
          <button class="w-full px-7 sm:px-8 lg:px-6 py-6 lg:py-3 bg-bar-gold border-[3px] lg:border-2 border-bar-gold rounded-full text-bar-dark text-3xl sm:text-4xl lg:text-base font-black lg:font-semibold
                         transition-all duration-300 hover:bg-transparent hover:text-bar-gold disabled:opacity-50 disabled:cursor-not-allowed" 
                  id="recommend-btn">おすすめを表示</button>
        </div>
      </div>
      
      <!-- カテゴリ未選択メッセージ -->
      <div id="recommend-no-category" class="text-center py-24 lg:py-12">
        <p class="text-4xl sm:text-5xl lg:text-lg text-bar-gray font-bold lg:font-medium mb-6 lg:mb-4">カテゴリを選択してください</p>
        <p class="text-2xl sm:text-3xl lg:text-base text-neutral-500">上記のカテゴリボタンから選んでください。</p>
      </div>
      
      <div id="recommend-error" class="hidden bg-red-900/10 border border-red-900/30 rounded-xl p-6 lg:p-4 text-red-300 text-2xl lg:text-base mb-6 lg:mb-4"></div>
      <div id="recommend-loading" class="hidden flex flex-col items-center justify-center py-20 lg:py-12 text-gray-500">
        <div class="border-4 border-bar-gray-dark border-t-bar-gold rounded-full w-20 lg:w-10 h-20 lg:h-10 animate-spin-custom mb-6 lg:mb-4"></div>
        <p class="text-2xl sm:text-3xl lg:text-base font-medium">おすすめを探しています...</p>
      </div>
      <div id="recommend-results" class="hidden mt-8"></div>
    </div>
  </div>
  
  <!-- 詳細モーダル -->
  <div id="detail-modal" class="hidden fixed inset-0 bg-black/85 flex items-center justify-center z-50 p-4 overflow-y-auto">
    <div class="bg-gradient-to-br from-neutral-900/95 to-black/98 border border-bar-gold rounded-2xl max-w-3xl w-full max-h-[90vh] 
                overflow-y-auto relative shadow-2xl shadow-bar-gold/30">
      <div class="sticky top-0 p-6 sm:p-8 lg:p-4 border-b border-bar-gold/20 bg-black/95 backdrop-blur-lg z-10">
        <button class="absolute top-4 lg:top-2 right-4 lg:right-2 w-9 lg:w-7 h-9 lg:h-7 flex items-center justify-center bg-transparent border border-neutral-700 
                       text-bar-gray rounded-full text-2xl lg:text-xl transition-all duration-300 hover:border-bar-gold hover:text-bar-gold 
                       hover:bg-bar-gold/10" 
                onclick="closeDetailModal()">×</button>
        <div id="modal-header-content"></div>
      </div>
      <div class="p-6 sm:p-8 lg:p-4">
        <div id="modal-body-content"></div>
      </div>
    </div>
  </div>
  
  <script>
    // データを後で取得（初期は空）
    let menuData = { items: [], total: 0, updatedAt: '' };
    let categories = [];
    let availableTags = [];
    let allMenuData = { items: [], total: 0, updatedAt: '' };
    
    // キャッシュ（セッション中有効）
    let menuDataCache = {}; // カテゴリごとのメニューデータキャッシュ { category: menuData }
    let tagsCache = {}; // カテゴリごとのタグキャッシュ { category: [tags] }
    
    // クイックフィルタの定義（一元管理）
    const AROMA_OPTIONS = {
      'smoky': 'スモーキー（Smoky）- ピートを焚いたような燻製香。アイラ系に多い',
      'peaty': 'ピーティ（Peaty）- スモークよりも泥炭の香りが強い。土っぽく、薬品っぽい印象も',
      'fruity': 'フルーティ（Fruity）- 果実のような甘酸っぱい香り。リンゴ、洋梨、桃など',
      'floral': 'フローラル（Floral）- 花のような華やかで繊細な香り',
      'honey': 'ハニー（Honeyed）- はちみつのような甘く丸い香り',
      'spicy': 'スパイシー（Spicy）- 胡椒やナツメグのような刺激。樽由来',
      'malty': 'モルティ（Malty）- 麦芽そのものの甘い穀物香',
      'woody': 'ウッディ（Woody / Oaky）- 熟成樽由来の木の香り、バニラ香、タンニン'
    };
    
    const TASTE_OPTIONS = {
      'sweet': 'スウィート（Sweet）- バニラ、キャラメル、ハチミツのような甘み',
      'dry': 'ドライ（Dry）- 甘さ控えめでキレのある印象',
      'rich': 'リッチ（Rich）- 濃厚で複雑。熟成感のある味わい',
      'light': 'ライト（Light）- 軽やかで飲みやすい',
      'oily': 'オイリー（Oily）- 舌にまとわりつくようなコク',
      'nutty': 'ナッティ（Nutty）- アーモンド、ヘーゼルナッツなどの香ばしさ',
      'smoky_taste': 'スモーキー / ピーティ - 香りだけでなく、味にも煙感・薬草感が出る',
      'chocolatey': 'チョコレーティ（Chocolatey）- カカオやビターチョコのような風味'
    };
    
    let currentTab = 'menu';
    let filters = {
      keyword: '',
      maker: '',
      category: '',
      type: '',
      tags: [], // メニュー検索用タグフィルタ
      recommendPrefs: {
        selectedTags: [],
        memo: '',
        quickFilters: {
          aroma: '', // 香り
          taste: ''  // 味わい
        }
      }
    };
    
    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      initTabs();
      initRecommend();
      initQuickFilterOptions();
      
      // サーバーからカテゴリのみを取得
      showLoading();
      
      google.script.run
        .withSuccessHandler(function(data) {
          if (!data || !data.categories) {
            showError('カテゴリの取得に失敗しました');
            return;
          }
          
          categories = data.categories;
          
          renderCategoryButtons();
          
          // カテゴリが1件の場合は自動選択
          if (categories.length === 1) {
            handleCategorySelect(categories[0]);
          } else {
            showCategorySelectionMessage();
            hideLoading();
          }
        })
        .withFailureHandler(function(error) {
          console.error('[init] Categories fetch failed:', error);
          hideLoading();
          const errorMessage = error && error.message ? error.message : 'カテゴリの読み込みに失敗しました';
          showError('カテゴリの読み込みに失敗しました: ' + errorMessage);
        })
        .getCategoriesForClient();
    });
    
    function showLoading() {
      const grid = document.getElementById('menu-grid');
      if (grid) {
        grid.innerHTML = '<div class="col-span-full flex flex-col items-center justify-center py-24 lg:py-12 text-gray-500"><div class="border-[5px] lg:border-4 border-bar-gray-dark border-t-bar-gold rounded-full w-24 lg:w-12 h-24 lg:h-12 animate-spin-custom mb-8 lg:mb-4"></div><p class="text-3xl sm:text-4xl lg:text-base font-medium">データを読み込んでいます...</p></div>';
      }
    }
    
    function hideLoading() {
      // renderMenu()が呼ばれるので特に処理不要
    }
    
    function showLoadingInTabArea() {
      document.getElementById('tab-loading').classList.remove('hidden');
    }
    
    function hideLoadingInTabArea() {
      document.getElementById('tab-loading').classList.add('hidden');
    }
    
    // カテゴリボタンのレンダリング
    function renderCategoryButtons() {
      const container = document.getElementById('category-buttons');
      if (!container) return;
      
      container.innerHTML = categories.map(cat => {
        const isSelected = filters.category === cat;
        return '<button class="category-btn px-7 sm:px-8 lg:px-4 py-5 lg:py-2 rounded-full text-2xl sm:text-3xl lg:text-sm font-black lg:font-medium transition-all duration-300 ' +
          (isSelected 
            ? 'bg-bar-gold border-[3px] lg:border-2 border-bar-gold text-bar-dark' 
            : 'bg-transparent border-[3px] lg:border-2 border-neutral-700 text-bar-gray hover:border-bar-gold hover:text-bar-gold') +
          '" data-category="' + escapeHtml(cat) + '">' + escapeHtml(cat) + '</button>';
      }).join('');
      
      // ボタンにイベントリスナーを追加
      container.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          handleCategorySelect(this.getAttribute('data-category'));
        });
      });
    }
    
    // カテゴリ選択メッセージの表示
    function showCategorySelectionMessage() {
      const grid = document.getElementById('menu-grid');
      const count = document.getElementById('menu-count');
      
      if (count) count.textContent = '';
      if (grid) {
        grid.innerHTML = '<div class="col-span-full text-center py-24 lg:py-12"><p class="text-4xl sm:text-5xl lg:text-lg text-bar-gray font-bold lg:font-medium mb-6 lg:mb-4">カテゴリを選択してください</p><p class="text-2xl sm:text-3xl lg:text-base text-neutral-500">上記のカテゴリボタンから選んで、検索してください。</p></div>';
      }
    }
    
    // カテゴリ選択時の処理
    function handleCategorySelect(category) {
      filters.category = category;
      filters.type = '';
      filters.maker = '';
      filters.keyword = '';
      filters.tags = []; // メニュー検索用タグもリセット
      filters.recommendPrefs.selectedTags = [];
      
      renderCategoryButtons();
      
      // タブとタブコンテンツを全て非表示にする
      document.getElementById('main-tabs').classList.add('hidden');
      document.getElementById('menu-tab').classList.add('hidden');
      document.getElementById('recommend-tab').classList.add('hidden');
      
      // 検索フィルタとおすすめフォームも非表示
      document.getElementById('search-filters').classList.add('hidden');
      document.getElementById('recommend-form').classList.add('hidden');
      document.getElementById('recommend-no-category').classList.add('hidden');
      
      // ローディング表示（タブエリアに表示）
      showLoadingInTabArea();
      
      // メニューデータを取得（キャッシュがあればそれを使う）
      if (menuDataCache[category]) {
        // キャッシュがある場合はすぐに使用
        menuData = menuDataCache[category];
        
        // メニューデータが取得できたらすぐに画面を表示
        initAfterCategorySelect();
      } else {
        // キャッシュがない場合はAPIから取得
        google.script.run
          .withSuccessHandler(function(data) {
            if (!data || !data.items) {
              showError('データの形式が不正です');
              hideLoadingInTabArea();
              return;
            }
            
            menuData = data;
            menuDataCache[category] = data; // キャッシュに保存
            
            // メニューデータが取得できたらすぐに画面を表示
            initAfterCategorySelect();
          })
          .withFailureHandler(function(error) {
            console.error('[handleCategorySelect] Data fetch failed:', error);
            hideLoadingInTabArea();
            showError('データの読み込みに失敗しました: ' + error.message);
          })
          .getMenuDataForClient({ category: category });
      }
      
      // タグを取得（キャッシュがあればそれを使う）
      if (tagsCache[category]) {
        // キャッシュがある場合はすぐに使用
        availableTags = tagsCache[category];
        initMenuTagFilter();
      } else {
        // キャッシュがない場合はAPIから取得
        google.script.run
          .withSuccessHandler(function(data) {
            if (!data || !Array.isArray(data.tags)) {
              availableTags = [];
              tagsCache[category] = [];
              return;
            }
            
            availableTags = data.tags;
            tagsCache[category] = data.tags; // キャッシュに保存
            
            // タグが取得できたらタグフィルタを更新
            initMenuTagFilter();
          })
          .withFailureHandler(function(error) {
            console.error('[handleCategorySelect] Tags fetch failed:', error);
            // タグの取得失敗は致命的ではないので、空配列で続行
            availableTags = [];
            tagsCache[category] = []; // 空でもキャッシュして再試行を防ぐ
          })
          .getTagsForCategory(category);
      }
    }
    
    // カテゴリ選択後の初期化処理
    function initAfterCategorySelect() {
      // ローディングを非表示
      hideLoadingInTabArea();
      
      // タブを表示
      document.getElementById('main-tabs').classList.remove('hidden');
      
      // タブコンテンツを表示（現在のタブに応じて）
      if (currentTab === 'menu') {
        document.getElementById('menu-tab').classList.remove('hidden');
      } else {
        document.getElementById('recommend-tab').classList.remove('hidden');
      }
      
      // フィルタとボタンを初期化
      initSearchFilters();
      
      // おすすめフォームを初期化
      initRecommendFilters();
      
      // メニュータブ: 検索フィルタを表示
      document.getElementById('search-filters').classList.remove('hidden');
      
      // おすすめタブ: フォームを表示、メッセージを非表示
      document.getElementById('recommend-form').classList.remove('hidden');
      document.getElementById('recommend-no-category').classList.add('hidden');
      
      // メニューをレンダリング
      renderMenu();
    }
    
    // タブ切り替え
    function initTabs() {
      const tabs = document.querySelectorAll('.tab-btn');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
      
      // 初期表示でメニュータブをアクティブに
      switchTab('menu');
    }
    
    function switchTab(tabName) {
      currentTab = tabName;
      
      // タブボタンのアクティブ状態
      document.querySelectorAll('.tab-btn').forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
          tab.classList.add('text-bar-gold', 'border-bar-gold');
          tab.classList.remove('border-transparent');
        } else {
          tab.classList.remove('text-bar-gold', 'border-bar-gold');
          tab.classList.add('border-transparent');
        }
      });
      
      // タブコンテンツの表示/非表示
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(tabName + '-tab').classList.remove('hidden');
    }
    
    // 検索フィルタ初期化
    function initSearchFilters() {
      // タイプ選択
      const typeSelect = document.getElementById('type-select');
      typeSelect.innerHTML = '<option value="">すべて</option>';
      const types = [...new Set(menuData.items.map(item => item.type).filter(Boolean))].sort();
      types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
      });
      
      // メーカー選択
      const makerSelect = document.getElementById('maker-select');
      makerSelect.innerHTML = '<option value="">すべて</option>';
      const makers = [...new Set(menuData.items.map(item => item.maker).filter(Boolean))].sort();
      makers.forEach(maker => {
        const option = document.createElement('option');
        option.value = maker;
        option.textContent = maker;
        makerSelect.appendChild(option);
      });
      
      // キーワード入力をクリア
      const keywordInput = document.getElementById('keyword-input');
      keywordInput.value = '';
      
      // タグ選択を初期化
      initMenuTagFilter();
      
      // 検索ボタン
      const searchBtn = document.getElementById('search-btn');
      searchBtn.onclick = function() {
        filters.type = typeSelect.value;
        filters.maker = makerSelect.value;
        filters.keyword = keywordInput.value;
        renderMenu();
      };
      
      // リセットボタン
      const resetBtn = document.getElementById('reset-btn');
      resetBtn.onclick = function() {
        // カテゴリは保持、検索条件のみリセット
        filters.type = '';
        filters.maker = '';
        filters.keyword = '';
        filters.tags = [];
        
        // フォームをリセット
        typeSelect.value = '';
        makerSelect.value = '';
        keywordInput.value = '';
        
        // タグ選択もリセット
        const tagSelect = document.getElementById('menu-tag-select');
        if (tagSelect) {
          tagSelect.selectedIndex = -1; // 全選択解除
        }
        
        // メニューを再表示
        renderMenu();
      };
    }
    
    // メニュー検索用タグフィルタ初期化
    function initMenuTagFilter() {
      const container = document.getElementById('menu-tag-filter-container');
      if (!container) return;
      
      // タグがない場合は非表示
      if (availableTags.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      // タグ選択ドロップダウンを生成（最大5件選択可）
      container.innerHTML = '<div>' +
        '<label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">タグ（味わいなど）' +
        '<span class="ml-2 text-lg lg:text-xs text-neutral-500">最大5件まで選択可</span></label>' +
        '<select id="menu-tag-select" multiple ' +
        'class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base ' +
        'focus:outline-none focus:border-bar-gold transition-colors min-h-[200px] lg:min-h-[150px]">' +
        availableTags.map(tag => {
          const isSelected = filters.tags.includes(tag);
          return '<option value="' + escapeHtml(tag) + '"' + (isSelected ? ' selected' : '') + '>' + escapeHtml(tag) + '</option>';
        }).join('') +
        '</select>' +
      '</div>';
      
      // イベントリスナーを追加
      const tagSelect = document.getElementById('menu-tag-select');
      if (tagSelect) {
        tagSelect.addEventListener('change', function() {
          handleMenuTagSelectChange(this);
        });
      }
    }
    
    // メニュー検索用タグ選択の変更（最大5件制限）
    function handleMenuTagSelectChange(selectElement) {
      const selectedOptions = Array.from(selectElement.selectedOptions);
      
      // 最大5件まで
      if (selectedOptions.length > 5) {
        // 最新の選択を解除
        selectedOptions[selectedOptions.length - 1].selected = false;
        alert('タグは最大5件まで選択できます。');
        return;
      }
      
      filters.tags = selectedOptions.map(option => option.value);
    }
    
    // クイックフィルタのオプションを動的に生成
    function initQuickFilterOptions() {
      // 香りのオプション生成
      const aromaSelect = document.getElementById('aroma-select');
      if (aromaSelect) {
        aromaSelect.innerHTML = '<option value="">未選択</option>';
        Object.keys(AROMA_OPTIONS).forEach(key => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = AROMA_OPTIONS[key];
          aromaSelect.appendChild(option);
        });
      }
      
      // 味わいのオプション生成
      const tasteSelect = document.getElementById('taste-select');
      if (tasteSelect) {
        tasteSelect.innerHTML = '<option value="">未選択</option>';
        Object.keys(TASTE_OPTIONS).forEach(key => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = TASTE_OPTIONS[key];
          tasteSelect.appendChild(option);
        });
      }
    }
    
    // レコメンド初期化（初回のみ）
    function initRecommend() {
      // おすすめボタン
      const recommendBtn = document.getElementById('recommend-btn');
      recommendBtn.addEventListener('click', function() {
        handleRecommend();
      });
      
      // クイックフィルタのドロップダウン
      const aromaSelect = document.getElementById('aroma-select');
      const tasteSelect = document.getElementById('taste-select');
      
      if (aromaSelect) {
        aromaSelect.addEventListener('change', function() {
          filters.recommendPrefs.quickFilters.aroma = this.value;
        });
      }
      
      if (tasteSelect) {
        tasteSelect.addEventListener('change', function() {
          filters.recommendPrefs.quickFilters.taste = this.value;
        });
      }
    }
    
    // レコメンドフィルタ初期化（カテゴリ選択ごと）
    function initRecommendFilters() {
      // おすすめタブではタグフィルタを使わない（フリーテキスト入力のみ）
      // 特に何も処理しない
    }
    
    // メニュー表示
    function renderMenu() {
      const grid = document.getElementById('menu-grid');
      const count = document.getElementById('menu-count');
      
      // フィルタリング
      let items = menuData.items;
      
      if (filters.type) {
        items = items.filter(item => item.type === filters.type);
      }
      
      if (filters.maker) {
        items = items.filter(item => item.maker === filters.maker);
      }
      
      if (filters.keyword) {
        const keyword = filters.keyword.toLowerCase();
        items = items.filter(item => {
          return (item.name && item.name.toLowerCase().includes(keyword)) ||
                 (item.maker && item.maker.toLowerCase().includes(keyword)) ||
                 (item.description && item.description.toLowerCase().includes(keyword)) ||
                 (item.tags && item.tags.some(tag => tag.toLowerCase().includes(keyword)));
        });
      }
      
      // タグフィルタ（AND検索：選択した全てのタグを持つアイテムのみ）
      if (filters.tags && filters.tags.length > 0) {
        items = items.filter(item => {
          if (!item.tags || item.tags.length === 0) return false;
          // 選択した全てのタグがアイテムのタグに含まれているか確認
          return filters.tags.every(selectedTag => item.tags.includes(selectedTag));
        });
      }
      
      // カウント表示
      count.textContent = items.length + '件の商品';
      
      // グリッド表示
      if (items.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center py-24 lg:py-12 text-gray-400 text-3xl sm:text-4xl lg:text-base font-medium">条件に一致する商品がありませんでした。</div>';
        return;
      }
      
      grid.innerHTML = items.map(item => {
        const tags = item.tags && item.tags.length > 0
          ? '<div class="flex flex-wrap gap-3 lg:gap-2">' + item.tags.map(tag => '<span class="px-4 py-2.5 lg:px-3 lg:py-1.5 bg-transparent border border-neutral-700 rounded-full text-neutral-300 text-lg lg:text-sm">#' + escapeHtml(tag) + '</span>').join('') + '</div>'
          : '';
        
        const prices = [];
        if (item.price30ml) prices.push('30ml ¥' + item.price30ml.toLocaleString('ja-JP'));
        if (item.price15ml) prices.push('15ml ¥' + item.price15ml.toLocaleString('ja-JP'));
        if (item.price10ml) prices.push('10ml ¥' + item.price10ml.toLocaleString('ja-JP'));
        const priceText = prices.length > 0 ? prices.join(' / ') : '';
        
        const typeDisplay = item.type ? escapeHtml(item.type) : '';
        
        return '<article class="flex flex-col bg-black/40 border border-neutral-800 rounded-3xl overflow-hidden backdrop-blur-sm transition-all duration-300 hover:border-bar-gold/50">' +
          '<div class="p-7 sm:p-8 lg:p-5">' +
            '<div class="flex flex-col gap-6 lg:gap-4">' +
              '<div class="flex flex-col gap-4 lg:gap-2.5">' +
                (typeDisplay ? '<span class="text-xl sm:text-2xl lg:text-sm text-bar-gold uppercase tracking-wider font-bold lg:font-semibold">' + typeDisplay + '</span>' : '') +
                '<h3 class="text-4xl sm:text-5xl lg:text-xl text-gray-100 font-serif font-black lg:font-semibold leading-tight">' + escapeHtml(item.name) + '</h3>' +
                '<p class="text-2xl sm:text-3xl lg:text-base text-neutral-400 font-semibold lg:font-medium">' + escapeHtml(item.maker) + '</p>' +
                '<p class="text-xl sm:text-2xl lg:text-base text-neutral-300 leading-relaxed line-clamp-3">' + escapeHtml(item.description || '') + '</p>' +
                (priceText ? '<p class="text-3xl sm:text-4xl lg:text-base text-bar-gold font-black lg:font-medium mt-3 lg:mt-1">' + priceText + '</p>' : '') +
              '</div>' +
              tags +
            '</div>' +
          '</div>' +
          '<div class="px-7 sm:px-8 lg:px-5 pb-7 sm:pb-8 lg:pb-5">' +
            '<button class="w-full px-6 py-5 lg:px-4 lg:py-2.5 bg-transparent border-[3px] lg:border-2 border-bar-gold rounded-full text-bar-gold text-2xl sm:text-3xl lg:text-sm font-black lg:font-medium transition-all duration-300 hover:bg-bar-gold hover:text-bar-dark" onclick="showDetailModal(\'' + item.id + '\'); event.stopPropagation();">詳しく見る</button>' +
          '</div>' +
        '</article>';
      }).join('');
    }
    
    // レコメンド処理
    function handleRecommend() {
      // カテゴリチェック
      if (!filters.category) {
        showError('カテゴリを選択してください');
        return;
      }
      
      const text = document.getElementById('recommend-text').value.trim();
      const quickFilters = filters.recommendPrefs.quickFilters;
      
      // フリーワード、香り、味わいのいずれかが入力されていることを確認
      if (!text && !quickFilters.aroma && !quickFilters.taste) {
        showError('フリーワード、香り、味わいのいずれかを入力してください');
        return;
      }
      
      // クイックフィルタの内容をテキストに追加
      let memoWithFilters = text;
      
      // 香りの希望を追加
      if (quickFilters.aroma && AROMA_OPTIONS[quickFilters.aroma]) {
        if (memoWithFilters) memoWithFilters += '\n';
        memoWithFilters += '【香りの希望】' + AROMA_OPTIONS[quickFilters.aroma];
      }
      
      // 味わいの希望を追加
      if (quickFilters.taste && TASTE_OPTIONS[quickFilters.taste]) {
        if (memoWithFilters) memoWithFilters += '\n';
        memoWithFilters += '【味わいの希望】' + TASTE_OPTIONS[quickFilters.taste];
      }
      
      // 全件を候補として送信（情報は最小限に）
      const candidates = menuData.items.map(item => ({
        id: item.id,
        name: item.name
      }));
      
      if (candidates.length === 0) {
        showError('候補が見つかりません');
        return;
      }
      
      const request = {
        prefs: {
          selectedTags: [], // タグフィルタは使わない
          memo: memoWithFilters,
          category: filters.category
        },
        candidates: candidates
      };
      
      // ローディング表示
      document.getElementById('recommend-error').classList.add('hidden');
      document.getElementById('recommend-results').classList.add('hidden');
      document.getElementById('recommend-loading').classList.remove('hidden');
      document.getElementById('recommend-btn').disabled = true;
      
      // Google Apps Scriptの関数を呼び出し
      google.script.run
        .withSuccessHandler(handleRecommendSuccess)
        .withFailureHandler(handleRecommendError)
        .recommend(request);
    }
    
    function handleRecommendSuccess(response) {
      document.getElementById('recommend-loading').classList.add('hidden');
      document.getElementById('recommend-btn').disabled = false;
      
      if (response.error) {
        // エラーコードに応じた表示
        if (response.code === 'RATE_LIMIT') {
          showError(response.message || '現在、おすすめ機能は利用できません。API利用制限に達しています。しばらく時間をおいてから再度お試しください。');
        } else {
          showError(response.message || 'エラーが発生しました');
        }
        return;
      }
      
      const data = response.data;
      const resultsDiv = document.getElementById('recommend-results');
      
      if (!data || !data.items || data.items.length === 0) {
        showError('おすすめが見つかりませんでした。');
        return;
      }
      
      // メニューに存在するアイテムのみをフィルタリング
      const validItems = data.items.filter(item => {
        const menuItem = menuData.items.find(m => m.id === item.id);
        if (!menuItem) {
          console.warn('Item not found in menu:', item.id);
        }
        return menuItem !== undefined;
      });
      
      if (validItems.length === 0) {
        console.error('No valid items found');
        showError('おすすめが見つかりませんでした。AIが返したIDがメニューに存在しません。');
        return;
      }
      
      resultsDiv.innerHTML = '<h2 class="text-5xl sm:text-6xl lg:text-3xl text-bar-gold font-serif font-black lg:font-semibold mb-10 lg:mb-6">おすすめの一杯</h2>' +
        (data.note ? '<p class="text-2xl sm:text-3xl lg:text-base text-bar-gray mb-10 lg:mb-6">' + escapeHtml(data.note) + '</p>' : '') +
        validItems.map(item => {
          const menuItem = menuData.items.find(m => m.id === item.id);
          
          return '<div class="bg-black/40 border border-neutral-800 rounded-3xl overflow-hidden backdrop-blur-sm transition-all duration-300 hover:border-bar-gold/50 mb-8 lg:mb-6">' +
            '<div class="p-8 sm:p-10 lg:p-6">' +
              '<div class="flex flex-col gap-6 lg:gap-4">' +
                '<div>' +
                  '<h3 class="text-4xl sm:text-5xl lg:text-2xl text-gray-100 font-black lg:font-semibold tracking-wide mb-4 lg:mb-2">' + escapeHtml(menuItem.name) + '</h3>' +
                  '<p class="text-2xl sm:text-3xl lg:text-base text-bar-gold font-bold lg:font-medium mb-6 lg:mb-4">' + escapeHtml(menuItem.maker) + '</p>' +
                  '<p class="text-2xl sm:text-3xl lg:text-base text-bar-gray leading-relaxed">' + escapeHtml(item.reason) + '</p>' +
                  (item.serve ? '<p class="text-xl lg:text-sm text-neutral-400 mt-4 lg:mt-3">おすすめの提供方法: ' + escapeHtml(item.serve) + '</p>' : '') +
                '</div>' +
                '<div><button class="w-full px-6 py-5 lg:px-4 lg:py-2.5 bg-transparent border-[3px] lg:border-2 border-bar-gold rounded-full text-bar-gold text-2xl sm:text-3xl lg:text-sm font-black lg:font-medium transition-all duration-300 hover:bg-bar-gold hover:text-bar-dark" onclick="showDetailModal(\'' + menuItem.id + '\'); event.stopPropagation();">詳しく見る</button></div>' +
              '</div>' +
            '</div>' +
          '</div>';
        }).join('');
      
      resultsDiv.classList.remove('hidden');
    }
    
    function handleRecommendError(error) {
      document.getElementById('recommend-loading').classList.add('hidden');
      document.getElementById('recommend-btn').disabled = false;
      showError('エラーが発生しました: ' + error.message);
    }
    
    function showError(message) {
      const errorDiv = document.getElementById('recommend-error');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      } else {
        // レコメンドエラー要素がない場合はメニューグリッドにエラー表示
        const grid = document.getElementById('menu-grid');
        if (grid) {
          grid.innerHTML = '<div class="error">' + message + '</div>';
        }
      }
    }
    
    // HTMLエスケープ
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 詳細モーダル表示
    function showDetailModal(itemId) {
      const item = menuData.items.find(i => i.id === itemId);
      if (!item) return;
      
      // ヘッダー
      const typeDisplay = item.type ? escapeHtml(item.type) : '';
      
      const headerHtml = (typeDisplay ? '<span class="text-xl sm:text-2xl lg:text-xs text-bar-gold uppercase tracking-widest font-black lg:font-semibold">' + typeDisplay + '</span>' : '') +
        '<h2 class="text-4xl sm:text-5xl lg:text-2xl text-gray-100 font-serif font-black lg:font-semibold mt-5 lg:mt-2">' + escapeHtml(item.name) + '</h2>' +
        '<p class="text-2xl sm:text-3xl lg:text-sm text-neutral-400 font-bold lg:font-medium mt-4 lg:mt-2">' + escapeHtml(item.maker) + '</p>' +
        (item.tags && item.tags.length > 0 ? '<div class="flex flex-wrap gap-3 lg:gap-2 mt-6 lg:mt-4">' + item.tags.map(tag => '<span class="px-5 py-3 lg:px-3 lg:py-1 border-2 lg:border border-neutral-700 rounded-full text-neutral-300 text-xl lg:text-xs">#' + escapeHtml(tag) + '</span>').join('') + '</div>' : '');
      
      // ボディ
      let bodyHtml = '';
      
      // テイスティングノート
      if (item.description) {
        bodyHtml += '<div class="mb-12 lg:mb-6">' +
          '<h3 class="text-2xl sm:text-3xl lg:text-xs text-bar-gold uppercase tracking-widest font-black lg:font-semibold mb-6 lg:mb-3">テイスティングノート</h3>' +
          '<p class="text-2xl sm:text-3xl lg:text-sm text-bar-gray leading-relaxed">' + escapeHtml(item.description) + '</p>' +
        '</div>';
      }
      
      // 価格
      const prices = [];
      if (item.price30ml) prices.push({ size: '30ml', price: item.price30ml });
      if (item.price15ml) prices.push({ size: '15ml', price: item.price15ml });
      if (item.price10ml) prices.push({ size: '10ml', price: item.price10ml });
      
      if (prices.length > 0) {
        bodyHtml += '<div class="mb-12 lg:mb-6">' +
          '<h3 class="text-2xl sm:text-3xl lg:text-xs text-bar-gold uppercase tracking-widest font-black lg:font-semibold mb-6 lg:mb-3">価格</h3>' +
          '<div class="flex gap-8 sm:gap-10 lg:gap-4 flex-wrap">' +
          prices.map(p => 
            '<div class="flex-1 min-w-[180px] lg:min-w-[100px]">' +
              '<div class="text-xl lg:text-xs text-gray-500 uppercase tracking-wide mb-4 lg:mb-1 font-bold lg:font-medium">' + p.size + '</div>' +
              '<div class="text-4xl sm:text-5xl lg:text-lg text-gray-100 font-black lg:font-semibold">¥' + p.price.toLocaleString('ja-JP') + '</div>' +
            '</div>'
          ).join('') +
          '</div>' +
        '</div>';
      }
      
      // 詳細情報
      const details = [];
      if (item.type) details.push({ label: 'タイプ', value: item.type });
      if (item.alcoholVolume) details.push({ label: 'アルコール度数', value: item.alcoholVolume + '%' });
      if (item.country) details.push({ label: '生産国', value: item.country });
      if (item.distillery) details.push({ label: '蒸溜所', value: item.distillery });
      if (item.maturationPeriod) details.push({ label: '熟成年数', value: item.maturationPeriod });
      if (item.caskType) details.push({ label: '樽種', value: item.caskType });
      
      if (details.length > 0) {
        bodyHtml += '<div class="mb-12 lg:mb-6">' +
          '<h3 class="text-2xl sm:text-3xl lg:text-xs text-bar-gold uppercase tracking-widest font-black lg:font-semibold mb-6 lg:mb-3">詳細情報</h3>' +
          '<div class="grid grid-cols-1 sm:grid-cols-2 gap-6 lg:gap-3">' +
          details.map(d => 
            '<div class="bg-bar-gold/5 border-2 lg:border border-bar-gold/20 rounded-2xl lg:rounded-lg p-6 sm:p-7 lg:p-3">' +
              '<div class="text-xl lg:text-xs text-gray-500 uppercase tracking-wide mb-4 lg:mb-1 font-bold lg:font-medium">' + escapeHtml(d.label) + '</div>' +
              '<div class="text-2xl sm:text-3xl lg:text-sm text-gray-100 font-black lg:font-semibold">' + escapeHtml(d.value) + '</div>' +
            '</div>'
          ).join('') +
          '</div>' +
        '</div>';
      }
      
      document.getElementById('modal-header-content').innerHTML = headerHtml;
      document.getElementById('modal-body-content').innerHTML = bodyHtml;
      document.getElementById('detail-modal').classList.remove('hidden');
      
      // ESCキーで閉じる
      document.addEventListener('keydown', handleEscKey);
    }
    
    function closeDetailModal() {
      document.getElementById('detail-modal').classList.add('hidden');
      document.removeEventListener('keydown', handleEscKey);
    }
    
    function handleEscKey(e) {
      if (e.key === 'Escape') {
        closeDetailModal();
      }
    }
    
    // モーダル外クリックで閉じる
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('detail-modal');
      if (e.target === modal) {
        closeDetailModal();
      }
    });
  </script>
</body>
</html>

