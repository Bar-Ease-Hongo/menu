<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Bar Ease Hongo メニュー</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bar-dark': '#0B0B0D',
            'bar-gold': '#C9A227',
            'bar-gold-light': '#E4C55A',
            'bar-gray': '#D9D9D9',
            'bar-gray-dark': '#2a2a2a',
          },
          fontFamily: {
            'serif': ['Playfair Display', 'serif'],
            'sans': ['Noto Sans JP', 'system-ui', 'sans-serif'],
          },
          fontSize: {
            'xxl': '1.75rem',
            'xxxl': '2rem',
          }
        }
      }
    }
  </script>
  <style>
    html {
      font-size: 18px;
    }
    
    body {
      font-family: 'Noto Sans JP', system-ui, sans-serif;
    }
    
    /* スクロールバー */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #C9A227;
      border-radius: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-spin-custom {
      animation: spin 1s linear infinite;
    }
    
    /* iOS Safariでのズーム防止 */
    @media screen and (max-width: 767px) {
      input, select, textarea {
        font-size: 18px !important;
      }
    }
  </style>
</head>
<body class="bg-bar-dark text-gray-100 overflow-x-hidden">
  <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8">
    <!-- ヘッダー -->
    <header class="mb-6 sm:mb-8 py-6 sm:py-8 border-b border-bar-gray-dark">
      <h1 class="text-6xl sm:text-6xl lg:text-5xl text-bar-gold font-serif font-black lg:font-bold mb-4 lg:mb-2">Bar Ease Hongo</h1>
      <p class="text-2xl sm:text-3xl lg:text-base text-bar-gray font-medium">心に残る一杯との出会いを。</p>
    </header>
    
    <!-- カテゴリ選択（共通） -->
    <div class="mb-6 sm:mb-8">
      <h2 class="text-2xl sm:text-3xl lg:text-base text-bar-gray mb-4 lg:mb-3 font-bold lg:font-semibold">カテゴリを選択</h2>
      <div id="category-buttons" class="flex flex-wrap gap-3 lg:gap-2">
        <!-- カテゴリボタンは動的に生成 -->
      </div>
    </div>
    
    <!-- タブ -->
    <div class="flex gap-4 sm:gap-5 lg:gap-3 mb-6 sm:mb-8 border-b-2 border-bar-gray-dark overflow-x-auto">
      <button class="tab-btn px-7 sm:px-8 lg:px-6 py-5 lg:py-3 text-2xl sm:text-3xl lg:text-base text-bar-gray border-b-2 border-transparent transition-all duration-300 hover:text-bar-gold whitespace-nowrap font-bold lg:font-semibold" 
              data-tab="menu">メニュー一覧</button>
      <button class="tab-btn px-7 sm:px-8 lg:px-6 py-5 lg:py-3 text-2xl sm:text-3xl lg:text-base text-bar-gray border-b-2 border-transparent transition-all duration-300 hover:text-bar-gold whitespace-nowrap font-bold lg:font-semibold" 
              data-tab="recommend">おすすめ</button>
    </div>
    
    <!-- メニュー一覧タブ -->
    <div id="menu-tab" class="tab-content">
      <!-- 検索フィルタ（カテゴリ選択後に表示） -->
      <div id="search-filters" class="hidden bg-black/40 border border-bar-gray-dark rounded-xl p-6 sm:p-7 lg:p-5 mb-6 sm:mb-8 backdrop-blur-sm">
        <div class="space-y-6 lg:space-y-4">
          <div>
            <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">タイプ</label>
            <select id="type-select" 
                    class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base
                           focus:outline-none focus:border-bar-gold transition-colors">
              <option value="">すべて</option>
            </select>
          </div>
          <div>
            <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">メーカー</label>
            <select id="maker-select" 
                    class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base
                           focus:outline-none focus:border-bar-gold transition-colors">
              <option value="">すべて</option>
            </select>
          </div>
          <div>
            <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">キーワード検索</label>
            <input type="text" id="keyword-input" 
                   class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base
                          focus:outline-none focus:border-bar-gold transition-colors"
                   placeholder="商品名、メーカー、説明文で検索...">
          </div>
          <div class="flex gap-3 lg:gap-2">
            <button id="search-btn" class="flex-1 px-7 sm:px-8 lg:px-6 py-6 lg:py-3 bg-bar-gold border-[3px] lg:border-2 border-bar-gold rounded-full text-bar-dark text-3xl sm:text-4xl lg:text-base font-black lg:font-semibold
                           transition-all duration-300 hover:bg-transparent hover:text-bar-gold">
              検索
            </button>
            <button id="reset-btn" class="px-7 sm:px-8 lg:px-6 py-6 lg:py-3 bg-transparent border-[3px] lg:border-2 border-neutral-700 rounded-full text-bar-gray text-2xl sm:text-3xl lg:text-sm font-bold lg:font-medium
                           transition-all duration-300 hover:border-bar-gold hover:text-bar-gold">
              リセット
            </button>
          </div>
        </div>
      </div>
      
      <div id="menu-count" class="text-2xl sm:text-3xl lg:text-base text-bar-gray mb-6 font-bold lg:font-medium"></div>
      <div id="menu-grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-5 sm:gap-6 mb-8"></div>
    </div>
    
    <!-- おすすめタブ -->
    <div id="recommend-tab" class="tab-content hidden">
      <!-- おすすめフォーム（カテゴリ選択後に表示） -->
      <div id="recommend-form" class="hidden bg-black/40 border border-bar-gray-dark rounded-xl p-6 sm:p-7 lg:p-5 mb-6 sm:mb-8 backdrop-blur-sm">
        <div class="space-y-6 lg:space-y-4">
          <div>
            <label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">気分や好みを自由に入力</label>
            <textarea id="recommend-text" 
                      class="w-full px-5 sm:px-6 lg:px-4 py-5 sm:py-5 lg:py-3 bg-black/40 border-2 lg:border border-neutral-700 rounded-xl lg:rounded-lg text-gray-100 text-xl lg:text-base
                             focus:outline-none focus:border-bar-gold transition-colors resize-y min-h-[180px] lg:min-h-[100px]"
                      placeholder="例: スモーキーでフルーティー、甘さ控えめのものが飲みたい"></textarea>
        </div>
          <div id="quick-filter-container">
            <!-- クイックフィルタは動的に生成 -->
          </div>
          <button class="w-full px-7 sm:px-8 lg:px-6 py-6 lg:py-3 bg-bar-gold border-[3px] lg:border-2 border-bar-gold rounded-full text-bar-dark text-3xl sm:text-4xl lg:text-base font-black lg:font-semibold
                         transition-all duration-300 hover:bg-transparent hover:text-bar-gold disabled:opacity-50 disabled:cursor-not-allowed" 
                  id="recommend-btn">おすすめを表示</button>
        </div>
      </div>
      
      <!-- カテゴリ未選択メッセージ -->
      <div id="recommend-no-category" class="text-center py-24 lg:py-12">
        <p class="text-4xl sm:text-5xl lg:text-lg text-bar-gray font-bold lg:font-medium mb-6 lg:mb-4">カテゴリを選択してください</p>
        <p class="text-2xl sm:text-3xl lg:text-base text-neutral-500">上記のカテゴリボタンから選んでください。</p>
      </div>
      
      <div id="recommend-error" class="hidden bg-red-900/10 border border-red-900/30 rounded-xl p-6 lg:p-4 text-red-300 text-2xl lg:text-base mb-6 lg:mb-4"></div>
      <div id="recommend-loading" class="hidden flex flex-col items-center justify-center py-20 lg:py-12 text-gray-500">
        <div class="border-4 border-bar-gray-dark border-t-bar-gold rounded-full w-20 lg:w-10 h-20 lg:h-10 animate-spin-custom mb-6 lg:mb-4"></div>
        <p class="text-2xl sm:text-3xl lg:text-base font-medium">おすすめを探しています...</p>
      </div>
      <div id="recommend-results" class="hidden mt-8"></div>
    </div>
  </div>
  
  <!-- 詳細モーダル -->
  <div id="detail-modal" class="hidden fixed inset-0 bg-black/85 flex items-center justify-center z-50 p-4 overflow-y-auto">
    <div class="bg-gradient-to-br from-neutral-900/95 to-black/98 border border-bar-gold rounded-2xl max-w-3xl w-full max-h-[90vh] 
                overflow-y-auto relative shadow-2xl shadow-bar-gold/30">
      <div class="sticky top-0 p-6 sm:p-8 lg:p-4 border-b border-bar-gold/20 bg-black/95 backdrop-blur-lg z-10">
        <button class="absolute top-4 lg:top-2 right-4 lg:right-2 w-9 lg:w-7 h-9 lg:h-7 flex items-center justify-center bg-transparent border border-neutral-700 
                       text-bar-gray rounded-full text-2xl lg:text-xl transition-all duration-300 hover:border-bar-gold hover:text-bar-gold 
                       hover:bg-bar-gold/10" 
                onclick="closeDetailModal()">×</button>
        <div id="modal-header-content"></div>
      </div>
      <div class="p-6 sm:p-8 lg:p-4">
        <div id="modal-body-content"></div>
      </div>
    </div>
  </div>
  
  <script>
    // データを後で取得（初期は空）
    let menuData = { items: [], total: 0, updatedAt: '' };
    let categories = [];
    let availableTags = [];
    let allMenuData = { items: [], total: 0, updatedAt: '' };
    
    let currentTab = 'menu';
    let filters = {
      keyword: '',
      maker: '',
      category: '',
      type: '',
      recommendPrefs: {
        selectedTags: [],
        memo: ''
      }
    };
    
    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      initTabs();
      initRecommend();
      
      // サーバーからカテゴリのみを取得
      showLoading();
      
      console.log('[init] Starting categories fetch...');
      
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('[init] Categories received:', data);
          
          if (!data || !data.categories) {
            showError('カテゴリの取得に失敗しました');
            return;
          }
          
          categories = data.categories;
          console.log('[init] Categories count:', categories.length);
          
          renderCategoryButtons();
          showCategorySelectionMessage();
          hideLoading();
        })
        .withFailureHandler(function(error) {
          console.error('[init] Categories fetch failed:', error);
          hideLoading();
          const errorMessage = error && error.message ? error.message : 'カテゴリの読み込みに失敗しました';
          showError('カテゴリの読み込みに失敗しました: ' + errorMessage);
        })
        .getCategoriesForClient();
      
      // タイムアウト設定（30秒）
      setTimeout(function() {
        if (categories.length === 0) {
          console.warn('[init] Timeout - no categories received after 30 seconds');
          hideLoading();
          showError('カテゴリの読み込みがタイムアウトしました。ページをリロードしてください。');
        }
      }, 30000);
    });
    
    function showLoading() {
      const grid = document.getElementById('menu-grid');
      if (grid) {
        grid.innerHTML = '<div class="col-span-full flex flex-col items-center justify-center py-24 lg:py-12 text-gray-500"><div class="border-[5px] lg:border-4 border-bar-gray-dark border-t-bar-gold rounded-full w-24 lg:w-12 h-24 lg:h-12 animate-spin-custom mb-8 lg:mb-4"></div><p class="text-3xl sm:text-4xl lg:text-base font-medium">データを読み込んでいます...</p></div>';
      }
    }
    
    function hideLoading() {
      // renderMenu()が呼ばれるので特に処理不要
    }
    
    // カテゴリボタンのレンダリング
    function renderCategoryButtons() {
      const container = document.getElementById('category-buttons');
      if (!container) return;
      
      container.innerHTML = categories.map(cat => {
        const isSelected = filters.category === cat;
        return '<button class="category-btn px-7 sm:px-8 lg:px-4 py-5 lg:py-2 rounded-full text-2xl sm:text-3xl lg:text-sm font-black lg:font-medium transition-all duration-300 ' +
          (isSelected 
            ? 'bg-bar-gold border-[3px] lg:border-2 border-bar-gold text-bar-dark' 
            : 'bg-transparent border-[3px] lg:border-2 border-neutral-700 text-bar-gray hover:border-bar-gold hover:text-bar-gold') +
          '" data-category="' + escapeHtml(cat) + '">' + escapeHtml(cat) + '</button>';
      }).join('');
      
      // ボタンにイベントリスナーを追加
      container.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          handleCategorySelect(this.getAttribute('data-category'));
        });
      });
    }
    
    // カテゴリ選択メッセージの表示
    function showCategorySelectionMessage() {
      const grid = document.getElementById('menu-grid');
      const count = document.getElementById('menu-count');
      
      if (count) count.textContent = '';
      if (grid) {
        grid.innerHTML = '<div class="col-span-full text-center py-24 lg:py-12"><p class="text-4xl sm:text-5xl lg:text-lg text-bar-gray font-bold lg:font-medium mb-6 lg:mb-4">カテゴリを選択してください</p><p class="text-2xl sm:text-3xl lg:text-base text-neutral-500">上記のカテゴリボタンから選んで、検索してください。</p></div>';
      }
    }
    
    // カテゴリ選択時の処理
    function handleCategorySelect(category) {
      console.log('[handleCategorySelect] Category:', category);
      
      filters.category = category;
      filters.type = '';
      filters.maker = '';
      filters.keyword = '';
      filters.recommendPrefs.selectedTags = [];
      
      renderCategoryButtons();
      
      // ローディング表示
      showLoading();
      
      // カテゴリのデータとタグを並行取得
      let menuDataReceived = false;
      let tagsReceived = false;
      let hasError = false;
      
      // メニューデータを取得
      google.script.run
        .withSuccessHandler(function(data) {
          if (hasError) return;
          
          console.log('[handleCategorySelect] Data received:', data);
          
          if (!data || !data.items) {
            hasError = true;
            showError('データの形式が不正です');
            return;
          }
          
          menuData = data;
          console.log('[handleCategorySelect] Menu items count:', menuData.items.length);
          menuDataReceived = true;
          
          // 両方取得完了したら初期化
          if (tagsReceived) {
            initAfterCategorySelect();
          }
        })
        .withFailureHandler(function(error) {
          if (hasError) return;
          hasError = true;
          console.error('[handleCategorySelect] Data fetch failed:', error);
          hideLoading();
          showError('データの読み込みに失敗しました: ' + error.message);
        })
        .getMenuDataForClient({ category: category });
      
      // タグを取得
      google.script.run
        .withSuccessHandler(function(data) {
          if (hasError) return;
          
          console.log('[handleCategorySelect] Tags received:', data);
          
          if (!data || !Array.isArray(data.tags)) {
            hasError = true;
            showError('タグデータの形式が不正です');
            return;
          }
          
          availableTags = data.tags;
          console.log('[handleCategorySelect] Available tags count:', availableTags.length);
          tagsReceived = true;
          
          // 両方取得完了したら初期化
          if (menuDataReceived) {
            initAfterCategorySelect();
          }
        })
        .withFailureHandler(function(error) {
          if (hasError) return;
          hasError = true;
          console.error('[handleCategorySelect] Tags fetch failed:', error);
          hideLoading();
          showError('タグの読み込みに失敗しました: ' + error.message);
        })
        .getTagsForCategory(category);
    }
    
    // カテゴリ選択後の初期化処理
    function initAfterCategorySelect() {
      // フィルタとボタンを初期化
      initSearchFilters();
      
      // おすすめフォームを初期化
      initRecommendFilters();
      
      // メニュータブ: 検索フィルタを表示
      document.getElementById('search-filters').classList.remove('hidden');
      
      // おすすめタブ: フォームを表示、メッセージを非表示
      document.getElementById('recommend-form').classList.remove('hidden');
      document.getElementById('recommend-no-category').classList.add('hidden');
      
      // メニューをレンダリング
      renderMenu();
    }
    
    // タブ切り替え
    function initTabs() {
      const tabs = document.querySelectorAll('.tab-btn');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
      
      // 初期表示でメニュータブをアクティブに
      switchTab('menu');
    }
    
    function switchTab(tabName) {
      currentTab = tabName;
      
      // タブボタンのアクティブ状態
      document.querySelectorAll('.tab-btn').forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
          tab.classList.add('text-bar-gold', 'border-bar-gold');
          tab.classList.remove('border-transparent');
        } else {
          tab.classList.remove('text-bar-gold', 'border-bar-gold');
          tab.classList.add('border-transparent');
        }
      });
      
      // タブコンテンツの表示/非表示
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(tabName + '-tab').classList.remove('hidden');
    }
    
    // 検索フィルタ初期化
    function initSearchFilters() {
      // タイプ選択
      const typeSelect = document.getElementById('type-select');
      typeSelect.innerHTML = '<option value="">すべて</option>';
      const types = [...new Set(menuData.items.map(item => item.type).filter(Boolean))].sort();
      types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
      });
      
      // メーカー選択
      const makerSelect = document.getElementById('maker-select');
      makerSelect.innerHTML = '<option value="">すべて</option>';
      const makers = [...new Set(menuData.items.map(item => item.maker).filter(Boolean))].sort();
      makers.forEach(maker => {
        const option = document.createElement('option');
        option.value = maker;
        option.textContent = maker;
        makerSelect.appendChild(option);
      });
      
      // キーワード入力をクリア
      const keywordInput = document.getElementById('keyword-input');
      keywordInput.value = '';
      
      // 検索ボタン
      const searchBtn = document.getElementById('search-btn');
      searchBtn.onclick = function() {
        filters.type = typeSelect.value;
        filters.maker = makerSelect.value;
        filters.keyword = keywordInput.value;
        renderMenu();
      };
      
      // リセットボタン
      const resetBtn = document.getElementById('reset-btn');
      resetBtn.onclick = function() {
        filters.category = '';
        filters.type = '';
        filters.maker = '';
        filters.keyword = '';
        
        // メニュータブ: 検索フィルタを非表示
        document.getElementById('search-filters').classList.add('hidden');
        
        // おすすめタブ: フォームを非表示、メッセージを表示
        document.getElementById('recommend-form').classList.add('hidden');
        document.getElementById('recommend-no-category').classList.remove('hidden');
        
        // カテゴリボタンをリセット
        renderCategoryButtons();
        
        // メッセージを表示
        showCategorySelectionMessage();
      };
    }
    
    // レコメンド初期化（初回のみ）
    function initRecommend() {
      // おすすめボタン
      const recommendBtn = document.getElementById('recommend-btn');
      recommendBtn.addEventListener('click', function() {
        handleRecommend();
      });
    }
    
    // レコメンドフィルタ初期化（カテゴリ選択ごと）
    function initRecommendFilters() {
      const container = document.getElementById('quick-filter-container');
      if (!container) return;
      
      // タグがない場合は非表示
      if (availableTags.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      // クイックフィルタを生成
      container.innerHTML = '<div>' +
        '<label class="block mb-4 lg:mb-2 text-bar-gray text-xl sm:text-2xl lg:text-sm font-bold lg:font-semibold">クイックフィルタ（味わい）' +
        '<span class="ml-2 text-lg lg:text-xs text-neutral-500">複数選択可</span></label>' +
        '<div id="tag-buttons" class="flex flex-wrap gap-4 lg:gap-2 mt-4 lg:mt-2">' +
        availableTags.map(tag => {
          const isSelected = filters.recommendPrefs.selectedTags.includes(tag);
          return '<button class="tag-filter-btn px-6 sm:px-7 lg:px-4 py-4 lg:py-2 rounded-full text-xl sm:text-2xl lg:text-sm font-bold lg:font-medium transition-all duration-300 ' +
            (isSelected 
              ? 'bg-bar-gold border-[3px] lg:border-2 border-bar-gold text-bar-dark' 
              : 'bg-transparent border-2 lg:border border-neutral-700 text-bar-gray hover:border-bar-gold hover:text-bar-gold') +
            '" data-tag="' + escapeHtml(tag) + '">' + escapeHtml(tag) + '</button>';
        }).join('') +
        '</div>' +
      '</div>';
      
      // イベントリスナーを追加
      container.querySelectorAll('.tag-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tag = this.getAttribute('data-tag');
          handleTagToggle(tag);
        });
      });
    }
    
    // タグの選択/解除
    function handleTagToggle(tag) {
      const index = filters.recommendPrefs.selectedTags.indexOf(tag);
      
      if (index !== -1) {
        // 解除
        filters.recommendPrefs.selectedTags.splice(index, 1);
      } else {
        // 選択
        filters.recommendPrefs.selectedTags.push(tag);
      }
      
      // 再レンダリング
      initRecommendFilters();
    }
    
    // メニュー表示
    function renderMenu() {
      const grid = document.getElementById('menu-grid');
      const count = document.getElementById('menu-count');
      
      // フィルタリング
      let items = menuData.items;
      
      if (filters.type) {
        items = items.filter(item => item.type === filters.type);
      }
      
      if (filters.maker) {
        items = items.filter(item => item.maker === filters.maker);
      }
      
      if (filters.keyword) {
        const keyword = filters.keyword.toLowerCase();
        items = items.filter(item => {
          return (item.name && item.name.toLowerCase().includes(keyword)) ||
                 (item.maker && item.maker.toLowerCase().includes(keyword)) ||
                 (item.description && item.description.toLowerCase().includes(keyword)) ||
                 (item.tags && item.tags.some(tag => tag.toLowerCase().includes(keyword)));
        });
      }
      
      // カウント表示
      count.textContent = items.length + '件の商品';
      
      // グリッド表示
      if (items.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center py-24 lg:py-12 text-gray-400 text-3xl sm:text-4xl lg:text-base font-medium">条件に一致する商品がありませんでした。</div>';
        return;
      }
      
      grid.innerHTML = items.map(item => {
        const tags = item.tags && item.tags.length > 0
          ? '<div class="flex flex-wrap gap-3 lg:gap-2">' + item.tags.map(tag => '<span class="px-4 py-2.5 lg:px-3 lg:py-1.5 bg-transparent border border-neutral-700 rounded-full text-neutral-300 text-lg lg:text-sm">#' + escapeHtml(tag) + '</span>').join('') + '</div>'
          : '';
        
        const prices = [];
        if (item.price30ml) prices.push('30ml ¥' + item.price30ml.toLocaleString('ja-JP'));
        if (item.price15ml) prices.push('15ml ¥' + item.price15ml.toLocaleString('ja-JP'));
        if (item.price10ml) prices.push('10ml ¥' + item.price10ml.toLocaleString('ja-JP'));
        const priceText = prices.length > 0 ? prices.join(' / ') : '';
        
        const typeDisplay = item.type ? escapeHtml(item.type) : '';
        
        return '<article class="flex flex-col bg-black/40 border border-neutral-800 rounded-3xl overflow-hidden backdrop-blur-sm transition-all duration-300 hover:border-bar-gold/50">' +
          '<div class="p-7 sm:p-8 lg:p-5">' +
            '<div class="flex flex-col gap-6 lg:gap-4">' +
              '<div class="flex flex-col gap-4 lg:gap-2.5">' +
                (typeDisplay ? '<span class="text-xl sm:text-2xl lg:text-sm text-bar-gold uppercase tracking-wider font-bold lg:font-semibold">' + typeDisplay + '</span>' : '') +
                '<h3 class="text-4xl sm:text-5xl lg:text-xl text-gray-100 font-serif font-black lg:font-semibold leading-tight">' + escapeHtml(item.name) + '</h3>' +
                '<p class="text-2xl sm:text-3xl lg:text-base text-neutral-400 font-semibold lg:font-medium">' + escapeHtml(item.maker) + '</p>' +
                '<p class="text-xl sm:text-2xl lg:text-base text-neutral-300 leading-relaxed line-clamp-3">' + escapeHtml(item.description || '') + '</p>' +
                (priceText ? '<p class="text-3xl sm:text-4xl lg:text-base text-bar-gold font-black lg:font-medium mt-3 lg:mt-1">' + priceText + '</p>' : '') +
              '</div>' +
              tags +
            '</div>' +
          '</div>' +
          '<div class="px-7 sm:px-8 lg:px-5 pb-7 sm:pb-8 lg:pb-5">' +
            '<button class="w-full px-6 py-5 lg:px-4 lg:py-2.5 bg-transparent border-[3px] lg:border-2 border-bar-gold rounded-full text-bar-gold text-2xl sm:text-3xl lg:text-sm font-black lg:font-medium transition-all duration-300 hover:bg-bar-gold hover:text-bar-dark" onclick="showDetailModal(\'' + item.id + '\'); event.stopPropagation();">詳しく見る</button>' +
          '</div>' +
        '</article>';
      }).join('');
    }
    
    // レコメンド処理
    function handleRecommend() {
      // カテゴリチェック
      if (!filters.category) {
        showError('カテゴリを選択してください');
        return;
      }
      
      const text = document.getElementById('recommend-text').value.trim();
      
      // フリーワードとクイックフィルタの両方が未入力の場合はエラー
      if (!text && filters.recommendPrefs.selectedTags.length === 0) {
        showError('フリーワードまたはクイックフィルタから1つ以上入力/選択してください');
        return;
      }
      
      // 全件を候補として送信（情報は最小限に）
      const candidates = menuData.items.map(item => ({
        id: item.id,
        name: item.name
      }));
      
      if (candidates.length === 0) {
        showError('候補が見つかりません');
        return;
      }
      
      const request = {
        prefs: {
          selectedTags: filters.recommendPrefs.selectedTags,
          memo: text,
          category: filters.category
        },
        candidates: candidates
      };
      
      // ローディング表示
      document.getElementById('recommend-error').classList.add('hidden');
      document.getElementById('recommend-results').classList.add('hidden');
      document.getElementById('recommend-loading').classList.remove('hidden');
      document.getElementById('recommend-btn').disabled = true;
      
      // Google Apps Scriptの関数を呼び出し
      google.script.run
        .withSuccessHandler(handleRecommendSuccess)
        .withFailureHandler(handleRecommendError)
        .recommend(request);
    }
    
    function handleRecommendSuccess(response) {
      document.getElementById('recommend-loading').classList.add('hidden');
      document.getElementById('recommend-btn').disabled = false;
      
      console.log('[handleRecommendSuccess] Response:', response);
      
      if (response.error) {
        // エラーコードに応じた表示
        if (response.code === 'RATE_LIMIT') {
          showError(response.message || '現在、おすすめ機能は利用できません。API利用制限に達しています。しばらく時間をおいてから再度お試しください。');
        } else {
          showError(response.message || 'エラーが発生しました');
        }
        return;
      }
      
      const data = response.data;
      const resultsDiv = document.getElementById('recommend-results');
      
      console.log('[handleRecommendSuccess] Data:', data);
      console.log('[handleRecommendSuccess] Items count:', data.items ? data.items.length : 0);
      
      if (!data || !data.items || data.items.length === 0) {
        console.error('[handleRecommendSuccess] No items in response');
        showError('おすすめが見つかりませんでした。');
        return;
      }
      
      // メニューに存在するアイテムのみをフィルタリング
      const validItems = data.items.filter(item => {
        const menuItem = menuData.items.find(m => m.id === item.id);
        if (!menuItem) {
          console.warn('[handleRecommendSuccess] Item not found in menu:', item.id, 'Available IDs:', menuData.items.map(m => m.id));
        }
        return menuItem !== undefined;
      });
      
      console.log('[handleRecommendSuccess] Valid items count:', validItems.length);
      
      if (validItems.length === 0) {
        console.error('[handleRecommendSuccess] No valid items found. AI returned items:', data.items.map(i => i.id));
        console.error('[handleRecommendSuccess] Available menu IDs:', menuData.items.map(m => m.id).slice(0, 10));
        showError('おすすめが見つかりませんでした。AIが返したIDがメニューに存在しません。');
        return;
      }
      
      resultsDiv.innerHTML = '<h2 class="text-5xl sm:text-6xl lg:text-3xl text-bar-gold font-serif font-black lg:font-semibold mb-10 lg:mb-6">おすすめの一杯</h2>' +
        (data.note ? '<p class="text-2xl sm:text-3xl lg:text-base text-bar-gray mb-10 lg:mb-6">' + escapeHtml(data.note) + '</p>' : '') +
        validItems.map(item => {
          const menuItem = menuData.items.find(m => m.id === item.id);
          
          return '<div class="bg-black/40 border border-neutral-800 rounded-3xl overflow-hidden backdrop-blur-sm transition-all duration-300 hover:border-bar-gold/50 mb-8 lg:mb-6">' +
            '<div class="p-8 sm:p-10 lg:p-6">' +
              '<div class="flex flex-col gap-6 lg:gap-4">' +
                '<div>' +
                  '<h3 class="text-4xl sm:text-5xl lg:text-2xl text-gray-100 font-black lg:font-semibold tracking-wide mb-4 lg:mb-2">' + escapeHtml(menuItem.name) + '</h3>' +
                  '<p class="text-2xl sm:text-3xl lg:text-base text-bar-gold font-bold lg:font-medium mb-6 lg:mb-4">' + escapeHtml(menuItem.maker) + '</p>' +
                  '<p class="text-2xl sm:text-3xl lg:text-base text-bar-gray leading-relaxed">' + escapeHtml(item.reason) + '</p>' +
                  (item.serve ? '<p class="text-xl lg:text-sm text-neutral-400 mt-4 lg:mt-3">提供方法: ' + escapeHtml(item.serve) + '</p>' : '') +
                '</div>' +
                '<div><button class="w-full px-6 py-5 lg:px-4 lg:py-2.5 bg-transparent border-[3px] lg:border-2 border-bar-gold rounded-full text-bar-gold text-2xl sm:text-3xl lg:text-sm font-black lg:font-medium transition-all duration-300 hover:bg-bar-gold hover:text-bar-dark" onclick="showDetailModal(\'' + menuItem.id + '\'); event.stopPropagation();">詳しく見る</button></div>' +
              '</div>' +
            '</div>' +
          '</div>';
        }).join('');
      
      resultsDiv.classList.remove('hidden');
    }
    
    function handleRecommendError(error) {
      document.getElementById('recommend-loading').classList.add('hidden');
      document.getElementById('recommend-btn').disabled = false;
      showError('エラーが発生しました: ' + error.message);
    }
    
    function showError(message) {
      const errorDiv = document.getElementById('recommend-error');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      } else {
        // レコメンドエラー要素がない場合はメニューグリッドにエラー表示
        const grid = document.getElementById('menu-grid');
        if (grid) {
          grid.innerHTML = '<div class="error">' + message + '</div>';
        }
      }
    }
    
    // HTMLエスケープ
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 詳細モーダル表示
    function showDetailModal(itemId) {
      const item = menuData.items.find(i => i.id === itemId);
      if (!item) return;
      
      // ヘッダー
      const typeDisplay = item.type ? escapeHtml(item.type) : '';
      
      const headerHtml = (typeDisplay ? '<span class="text-xl sm:text-2xl lg:text-xs text-bar-gold uppercase tracking-widest font-black lg:font-semibold">' + typeDisplay + '</span>' : '') +
        '<h2 class="text-4xl sm:text-5xl lg:text-2xl text-gray-100 font-serif font-black lg:font-semibold mt-5 lg:mt-2">' + escapeHtml(item.name) + '</h2>' +
        '<p class="text-2xl sm:text-3xl lg:text-sm text-neutral-400 font-bold lg:font-medium mt-4 lg:mt-2">' + escapeHtml(item.maker) + '</p>' +
        (item.tags && item.tags.length > 0 ? '<div class="flex flex-wrap gap-3 lg:gap-2 mt-6 lg:mt-4">' + item.tags.map(tag => '<span class="px-5 py-3 lg:px-3 lg:py-1 border-2 lg:border border-neutral-700 rounded-full text-neutral-300 text-xl lg:text-xs">#' + escapeHtml(tag) + '</span>').join('') + '</div>' : '');
      
      // ボディ
      let bodyHtml = '';
      
      // テイスティングノート
      if (item.description) {
        bodyHtml += '<div class="mb-12 lg:mb-6">' +
          '<h3 class="text-2xl sm:text-3xl lg:text-xs text-bar-gold uppercase tracking-widest font-black lg:font-semibold mb-6 lg:mb-3">テイスティングノート</h3>' +
          '<p class="text-2xl sm:text-3xl lg:text-sm text-bar-gray leading-relaxed">' + escapeHtml(item.description) + '</p>' +
        '</div>';
      }
      
      // 価格
      const prices = [];
      if (item.price30ml) prices.push({ size: '30ml', price: item.price30ml });
      if (item.price15ml) prices.push({ size: '15ml', price: item.price15ml });
      if (item.price10ml) prices.push({ size: '10ml', price: item.price10ml });
      
      if (prices.length > 0) {
        bodyHtml += '<div class="mb-12 lg:mb-6">' +
          '<h3 class="text-2xl sm:text-3xl lg:text-xs text-bar-gold uppercase tracking-widest font-black lg:font-semibold mb-6 lg:mb-3">価格</h3>' +
          '<div class="flex gap-8 sm:gap-10 lg:gap-4 flex-wrap">' +
          prices.map(p => 
            '<div class="flex-1 min-w-[180px] lg:min-w-[100px]">' +
              '<div class="text-xl lg:text-xs text-gray-500 uppercase tracking-wide mb-4 lg:mb-1 font-bold lg:font-medium">' + p.size + '</div>' +
              '<div class="text-4xl sm:text-5xl lg:text-lg text-gray-100 font-black lg:font-semibold">¥' + p.price.toLocaleString('ja-JP') + '</div>' +
            '</div>'
          ).join('') +
          '</div>' +
        '</div>';
      }
      
      // 詳細情報
      const details = [];
      if (item.type) details.push({ label: 'タイプ', value: item.type });
      if (item.alcoholVolume) details.push({ label: 'アルコール度数', value: item.alcoholVolume + '%' });
      if (item.country) details.push({ label: '生産国', value: item.country });
      if (item.distillery) details.push({ label: '蒸溜所', value: item.distillery });
      if (item.maturationPeriod) details.push({ label: '熟成年数', value: item.maturationPeriod });
      if (item.caskType) details.push({ label: '樽種', value: item.caskType });
      
      if (details.length > 0) {
        bodyHtml += '<div class="mb-12 lg:mb-6">' +
          '<h3 class="text-2xl sm:text-3xl lg:text-xs text-bar-gold uppercase tracking-widest font-black lg:font-semibold mb-6 lg:mb-3">詳細情報</h3>' +
          '<div class="grid grid-cols-1 sm:grid-cols-2 gap-6 lg:gap-3">' +
          details.map(d => 
            '<div class="bg-bar-gold/5 border-2 lg:border border-bar-gold/20 rounded-2xl lg:rounded-lg p-6 sm:p-7 lg:p-3">' +
              '<div class="text-xl lg:text-xs text-gray-500 uppercase tracking-wide mb-4 lg:mb-1 font-bold lg:font-medium">' + escapeHtml(d.label) + '</div>' +
              '<div class="text-2xl sm:text-3xl lg:text-sm text-gray-100 font-black lg:font-semibold">' + escapeHtml(d.value) + '</div>' +
            '</div>'
          ).join('') +
          '</div>' +
        '</div>';
      }
      
      document.getElementById('modal-header-content').innerHTML = headerHtml;
      document.getElementById('modal-body-content').innerHTML = bodyHtml;
      document.getElementById('detail-modal').classList.remove('hidden');
      
      // ESCキーで閉じる
      document.addEventListener('keydown', handleEscKey);
    }
    
    function closeDetailModal() {
      document.getElementById('detail-modal').classList.add('hidden');
      document.removeEventListener('keydown', handleEscKey);
    }
    
    function handleEscKey(e) {
      if (e.key === 'Escape') {
        closeDetailModal();
      }
    }
    
    // モーダル外クリックで閉じる
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('detail-modal');
      if (e.target === modal) {
        closeDetailModal();
      }
    });
  </script>
</body>
</html>

