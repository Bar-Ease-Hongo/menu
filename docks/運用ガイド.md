## 運用ガイド (Bedrock / SST / Next.js)

### 1. Lambda の依存解決ポリシー
`nodejs.install` は使用しません。代わりに esbuild (Ion) がワークスペース内 TS/ESM をバンドルします。これにより `npm install` サブプロセス失敗 (exit status 1) を回避。

### 2. 共通パッケージ構造
`@bar-ease/common` は `packages/common` に配置し、Bedrock ラッパ (`invokeClaude`, `createEmbedding`, `logBedrockEnv`) を提供します。追加ユーティリティもここに集約してください。

### 3. Bedrock モデル権限
IAM は `bedrock:InvokeModel` / `bedrock:InvokeModelWithResponseStream` を対象モデル ARN のみに限定。モデル ID はラッパ内 allow-list プレフィックスで早期検知。

### 4. デプロイ手順
1. `pnpm install` (Node 20 LTS 推奨)
2. （任意）`pnpm -F @bar-ease/common build` ※現状はソース参照で済むため必須ではない
3. `npm run deploy:sst:dev`

### 5. ログ監視 (今後)
CloudWatch Logs に以下パターンでメトリクスフィルタ設定推奨:
- `[timestamp=*Z, ... "[bedrock] invokeClaude success" ...]` => Count=1
- `[timestamp=*Z, ... "[bedrock] createEmbedding success" ...]` => Count=1

### 6. 推奨今後タスク
- メニュー生成の差分最適化 (GSI 検討)
- Embedding キャッシュ (S3 hash key)
- CloudFront キャッシュヘッダ調整 (`menu.json` の s-maxage チューニング)

### 6.1 GAS からの AI サジェスト取得 (Pattern A Pull)
`GET /ai/suggestions` を Google Apps Script から定期実行して「AI候補説明文」「AI候補画像URL」を埋める仕組み。

必要な Script Properties:
- `WEBHOOK_SECRET` : 既存の署名用シークレット (POST と共用)
- `AI_SUGGESTIONS_URL` : 例 `https://<api-id>.execute-api.<region>.amazonaws.com/ai/suggestions`

GAS 追加関数:
- `fetchAiSuggestions({ overwrite: false })` : 空セルのみ反映 (承認済み行はスキップ)
- `manualFetchAiSuggestions()` : エディタから手動実行用

HMAC 署名仕様 (GET): `HMAC_SHA256( timestamp + '.GET' )` → hex lower, ヘッダ `X-Timestamp`, `X-Signature`

推奨トリガー:
- 時間主導: 15 分毎 (候補生成頻度に応じ調整)
- 手動: オペレータが新規商品名入力後に実行し即時補完を確認

上書きポリシー変更:
- 強制上書きが必要な場合 `fetchAiSuggestions({ overwrite: true })` を実行

承認フロー:
1. 候補列を確認 (AIステータス: NeedsReview)
2. 問題なければ「承認フラグ」を 承認 に変更
3. Webhook → 本番公開画像キー反映 → Sync → menu.json / embeddings.json 再生成
4. AIステータス: Approved に更新

### 7. トラブルシューティング
| 症状 | 想定原因 | 対処 |
|------|----------|------|
| `failed to run npm install` | `nodejs.install` 使用 | 該当ブロック削除し再デプロイ |
| Bedrock AccessDenied | IAM/モデル ARN 不一致 | sst.config.ts の ARN と環境変数を確認 |
| 型解決失敗 `@bar-ease/common` | パス/exports 不整合 | `tsconfig.base.json` と `packages/common/package.json` を確認 |

---
更新日: 2025-10-07
