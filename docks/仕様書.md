# Bar Ease Hongo メニューアプリ 仕様書（AI Agent 提示用 / スプレッドシート拡張版）

本仕様は、**現行のスプレッドシート列構成を拡張**し、**AIによる自動補完機能と承認フロー**を備えたメニュー配信アプリを構築するための指示書です。デザインは既存公式サイト（[https://www.bareasehongo.com/）のトーンを踏襲し、**スマホ最適化＋レスポンシブ**構成を採用します。](https://www.bareasehongo.com/）のトーンを踏襲し、**スマホ最適化＋レスポンシブ**構成を採用します。)

---

## 1. 目的 / ゴール

* 店舗管理は **Google スプレッドシート**のみ（SSOT運用）。
* シート編集 → GAS → AWS で `menu.json` 自動生成。
* 欠損項目は **Amazon Bedrock (Claude/Titan)** により自動補完候補生成。
* スタッフが承認すると公開データに反映。
* UIはスマホ前提（黒＋金＋白の高級感デザイン）、PC/タブレットでも自然に表示。

---

## 2. データ構造（スプレッドシート）

### 利用スプレッドシート（テスト用 → 本番置換想定）

* **テスト用スプレッドシートURL**：[https://docs.google.com/spreadsheets/d/1qcQLHs79uzjX04yBhj6Y9Q-61RKt4DpxkPo2_kmIpIM/edit?usp=drive_link](https://docs.google.com/spreadsheets/d/1qcQLHs79uzjX04yBhj6Y9Q-61RKt4DpxkPo2_kmIpIM/edit?usp=drive_link)
* 現段階では上記を **開発・テスト用シート** として使用。
* **本番運用時** はオーナーがGoogleドライブに保有する別シートに置き換える想定とし、コード側では **シートIDを環境変数で管理** して切替可能な設計とする（例：`SHEET_ID`）。

### 2.1 既存列（添付シートより）

| 列名                 | 内容                |
| ------------------ | ----------------- |
| 国                  | 生産国               |
| 製造会社               | メーカー（製造元）         |
| 販売会社               | 販売元               |
| 蒸溜所                | 蒸溜所名              |
| タイプ                | 種別（例：シングルモルト）     |
| 樽番号                | バレルナンバー           |
| 商品名                | 商品表示名             |
| 備考                 | 補足メモ              |
| 熟成地                | 熟成場所              |
| 樽種                 | シェリー樽／バーボン樽など     |
| 熟成期間               | 例：12年             |
| 現行                 | 販売状況（現行／終売）       |
| ピート感               | 味わい特徴（※今後はタグ列に統合） |
| 度数                 | アルコール度数           |
| 本数                 | 提供可能本数            |
| 30ml / 15ml / 10ml | グラス単位の価格          |

### 2.2 追加列（AI補完・承認・公開制御）

| 列名                      | 内容                                           | 補完    | 承認要否  |
| ----------------------- | -------------------------------------------- | ----- | ----- |
| id                      | 一意ID                                         | -     | -     |
| status                  | 公開状態（Published/Draft）                        | -     | -     |
| maker                   | 製造/販売会社の正規化名                                 | ✅     | ❌     |
| makerSlug               | URL用スラッグ                                     | GAS自動 | ❌     |
| category                | 表示カテゴリ（タイプの正規化）                              | ✅     | ❌     |
| tags                    | 味覚/特徴タグ（sweet, smokyなど）                      | ✅     | ✅     |
| description             | 公開用説明文                                       | ✅     | ✅     |
| aiSuggestedDescription  | AI生成候補文                                      | 生成結果  | -     |
| aiSuggestedImageUrl     | 候補画像URL（S3 staging）                          | ✅     | ✅     |
| imageUrl                | 公開画像URL（S3 public）                           | ✅     | ✅     |
| aiStatus                | AIレビュー状態（None/NeedsReview/Approved/Rejected） | -     | -     |
| approveFlag             | 承認フラグ（Approved/Rejected/-）                   | -     | ✅     |
| approvedBy / approvedAt | 承認者・承認日時                                     | -     | GAS自動 |
| updatedAt               | ISO8601日時                                    | -     | GAS自動 |

### 2.3 AI補完対象列（拡張）

AIが候補を自動生成する列（商品名があれば推定可能）

| 列名          | 補完内容            | 元データ利用             | モデル                |
| ----------- | --------------- | ------------------ | ------------------ |
| 国           | 生産国             | 商品名・蒸溜所名・タイプ       | Claude 3           |
| 製造会社        | 製造元             | 商品名・タイプ            | Claude 3           |
| 販売会社        | 販売元             | 商品名                | Claude 3           |
| 蒸溜所         | 蒸溜所名            | 商品名                | Claude 3           |
| タイプ         | 種別（例：シングルモルトなど） | 商品名                | Claude 3           |
| 熟成地         | 熟成場所            | 商品名・国              | Claude 3           |
| 樽種          | 熟成樽の種類          | 商品名・タイプ            | Claude 3           |
| 熟成期間        | 年数（例：12年）       | 商品名                | Claude 3           |
| 度数          | アルコール度数         | 商品名                | Claude 3           |
| maker       | 製造/販売会社の統合正規化   | 製造会社/販売会社          | Claude 3 + 正規化辞書   |
| category    | タイプを標準化した分類     | タイプ列               | Claude 3 + ルール     |
| tags        | 味覚/香りの特徴タグ      | description, ピート感等 | Claude 3           |
| description | 商品説明文           | 各列                 | Claude 3           |
| imageUrl    | 商品画像URL         | Webクロール            | Claude 3 + Scraper |
| makerSlug   | 英字スラッグ          | maker列             | GASロジック            |

> ※価格（30ml/15ml/10ml）はお店側が設定するため **補完対象外**。ブログURLも今回は未使用。

---

## 3. AI補完フロー

1. Lambda がシート or S3の `menu.json` をスキャン。
2. 欠損セル（上記対象列）を抽出。
3. Claude 3（Haiku）にプロンプト送信。

   ```
   以下のウイスキーデータから欠損項目を補完してください。
   出力フォーマット: JSON {"country": "JP", "type": "シングルモルト", "description": "...", "tags": ["peaty", "rich"], "imageUrl": "..."}
   ```
4. 結果を `aiSuggested*` 列に書戻し、`aiStatus=NeedsReview` に設定。
5. 店舗スタッフがシートで確認し、`approveFlag=Approved` を選択。
6. GASがWebhookを通知 → Lambdaが `staging→public` コピー・`menu.json`再生成。

---

## 4. フロントエンド設計（スマホ優先 / 高級感デザイン）

### トーン＆マナー

* 背景：#0B0B0D（黒）
* テキスト：#F5F5F5（白）／#D9D9D9（グレー）
* アクセント：#C9A227（金）
* フォント：セリフ系タイトル + サンセリフ本文
* 余白多め、写真を主役に

### レイアウト

| 画面             | コンポーネント | 備考                                |
| -------------- | ------- | --------------------------------- |
| `/menu`        | 一覧      | メーカー/カテゴリフィルタ + 検索 + カードリスト（1カラム） |
| `/menu/[id]`   | 詳細      | 写真大・度数・熟成・タグ・説明・関連おすすめ            |
| `/menu?maker=` | 絞込      | QRアクセスでメーカー限定表示                   |

### レスポンシブ

* スマホ：1カラム・上下スクロール
* タブレット：2カラム・横余白調整
* PC：2〜3カラム・フィルタサイド配置

---

## 5. インフラ構成

* **S3**：menu.json, makers.json, embeddings.json, 画像
* **CloudFront**：CDN配信（`/menu.json`のみInvalidation）
* **API Gateway + Lambda**：`/sync/menu`（Upsert/Delete）、`/webhook`（承認）、`/recommend`
* **Bedrock**：Claude 3（説明/タグ/構造補完） + Titan Embeddings（類似度）
* **GAS**：onEdit / 時間トリガで `/sync/menu` を呼び出し、承認時に `/webhook` を送信
* **SST v3 + CDK v3**：IaC + ステージ管理

---

## 6. 運用ルール

* スプレッドシートは店舗用マスター。AI補完は候補のみ書戻し。
* 承認済み (`Approved`) のみ `menu.json` に反映。
* CloudFrontは `/menu.json` のみInvalidation。
* 画像は `staging` から承認後 `public` に移動。

---

## 7. 仕様確認まとめ

| 項目          | 補完  | 承認 | 備考            |
| ----------- | --- | -- | ------------- |
| 国           | ✅   | ❌  | 商品名から推定       |
| 製造会社        | ✅   | ❌  | 商品名から補完       |
| 販売会社        | ✅   | ❌  | 商品名から補完       |
| 蒸溜所         | ✅   | ❌  | 商品名から補完       |
| タイプ         | ✅   | ❌  | カテゴリ正規化に利用    |
| 熟成地         | ✅   | ❌  | 国や蒸溜所と整合      |
| 樽種          | ✅   | ❌  | 商品名・タイプ参照     |
| 熟成期間        | ✅   | ❌  | 商品名解析         |
| 度数          | ✅   | ❌  | 商品名解析         |
| maker       | ✅   | ❌  | 製造/販売会社統合     |
| makerSlug   | GAS | ❌  | 自動生成          |
| category    | ✅   | ❌  | タイプ標準化        |
| tags        | ✅   | ✅  | 味覚タグ（旧ピート感統合） |
| description | ✅   | ✅  | 公開説明文         |
| imageUrl    | ✅   | ✅  | 代表画像          |

---

## 8. 受け入れ基準（DoD）

* シート編集→5分以内に `menu.json` 更新
* 欠損項目は自動補完候補生成（NeedsReview）
* 承認済みのみ公開に反映
* `/menu?maker=` のQR表示で対象メーカー限定リスト表示
* スマホでCLS/INP良好（LCP<2.5s）

---

## 9. AI Agent プロンプト指示

```
あなたはフルスタックエンジニアとして振る舞ってください。
この仕様書に基づき、以下の観点で提案・実装を行ってください：
1. AI補完対象列のプロンプト設計（Claude 3用）
2. Lambda内AI補完・承認フローのコード例
3. GAS onEdit / Webhook署名POSTコード
4. menu.json生成・S3反映・CloudFront設定
5. Next.js UI構成（スマホ最適+レスポンシブ）
6. S3キャッシュ設計 / Invalidation方針
```

---

## 10. お客様向け AI レコメンド（好み入力→提案）

### 10.1 目的

* お客様が **自然文** または **簡易選択（タグ/スライダー）** で好み・気分を入力すると、**現在のメニュー（承認済みデータ）** から最適なお酒を提示する。
* スマホ前提で「数タップ／数秒」で提案結果に到達する UX。

### 10.2 データ前提

* レコメンドは **承認済みレコードのみ** を対象にする（`status=Published`、`aiStatus=Approved`）。
* `embeddings.json` を用意（`[{ id, vector: number[] }]`）。ベクトルは `(name + tags + description + type/maker/category)` を連結したテキストで作成。
* ベクトル生成：**Amazon Bedrock Titan Embeddings**（手動 or 日次バッチ Lambda）。

### 10.3 処理フロー（API `/recommend`）

1. **入力**（Next.js → API Gateway → Lambda）

   ```json
   {
     "text": "スモーキーでフルーティー、アルコール強め",
     "filters": { "abv": "high", "priceRange": "mid", "category": ["シングルモルト"] },
     "limit": 5
   }
   ```
2. **類似度計算**（Lambda）：

   * `text` を Titan Embeddings でベクトル化。
   * `embeddings.json` と **コサイン類似度**を計算し上位 `K=20` を取得。
   * `filters`（abv/price/category/maker など）でスコアに重み付け or 除外。
3. **（任意）Claude リランキング**：

   * 候補上位 `K` と `text` を **Claude 3 Haiku** へ渡し、文脈整合で 1〜`limit` 件を JSON で並べ替え。
4. **応答**：

   ```json
   {
     "items": [
       {
         "id": "DRK-00123",
         "score": 0.94,
         "name": "アードベッグ 10年",
         "maker": "Ardbeg",
         "imageUrl": "https://cdn.../ardbeg10.jpg",
         "reason": "アイラ由来のスモーキーさに、柑橘のニュアンス。度数もしっかりめ。"
       }
     ]
   }
   ```

### 10.4 ランキング式（ハイブリッド）

* 最終スコア = `λ1 * 類似度（Embeddings） + λ2 * ルールスコア（タグ/abv/価格/カテゴリ） + λ3 * Claude補正`
* 既定：`λ1=0.6, λ2=0.3, λ3=0.1`（環境変数で調整可）。

### 10.5 UI 仕様（スマホ優先）

* `/recommend`：

  * **入力欄**：テキスト（マイク/音声入力は任意）
  * **クイック選択**：チップ（甘口/辛口、スモーキー、フルーティー、度数：弱/中/強、価格帯、カテゴリ）
  * **CTA**：「おすすめを表示」（固定ボタン、下部安全域対応）
* `/recommend/result`：

  * **カード表示**：サムネ／名前／メーカー／度数／一言コメント（`reason`）
  * **アクション**：「詳しく見る」→ `/menu/[id]`
  * **再検索**：入力ボックスを上部固定（値保持）

### 10.6 パフォーマンス/コスト

* `menu.json` と `embeddings.json` は **短期キャッシュ（5分）** を Lambda 側で保持して I/O 削減。
* Titan Embeddings は **小文** 入力前提でコスト最小化。
* Claude リランキングは **任意**（A/B テストで有無を比較）。

### 10.7 API 仕様詳細

* **Endpoint**：`POST /recommend`
* **Request**：`{ text: string; filters?: { abv?: 'low'|'mid'|'high'; priceRange?: 'low'|'mid'|'high'; category?: string[]; maker?: string[] }; limit?: number }`
* **Response**：`{ items: Array<{ id: string; score: number; name: string; maker: string; imageUrl?: string; reason?: string }> }`
* **Errors**：`400`（text未指定）、`503`（モデル不調時はルールスコアのみで代替）

### 10.8 セキュリティ/倫理

* レコメンドは **店内メニューのみ** を対象（未承認・終売品を提案しない）。
* 危険喚起：度数が高い商品には「強めです」のUI表示（未成年配慮のため啓発文も可）。

### 10.9 受け入れ条件（追補）

* テキスト入力に対して **3件以上** の提案が 2 秒前後で返る（中容量ネット）。
* 同一入力に対して **一貫した上位結果** を返す（軽微な順序変動は容認）。
* フィルタ（例：`abv=high`）が **実際の候補絞込に反映** されていること。

---

## AI モデル利用・権限付与（SST v3 対応）

### 目的
- GAS による入力をトリガに AI 補完（Claude 3 Haiku）
- 自然文からのレコメンド（Titan Embeddings v2）

### 実装
- `sst.config.ts` 内で **モデル ID / ARN** を定義し、該当 Lambda にのみ **最小権限**で付与。
- NightlyMenuCompletion（定期補完バッチ）:
  - `bedrock:InvokeModel`, `bedrock:InvokeModelWithResponseStream` → `anthropic.claude-3-haiku-20240307-v1:0` の ARN 限定
- Recommend（API 経由のレコメンド）:
  - `bedrock:InvokeModel` → `amazon.titan-embed-text-v2:0` の ARN 限定

### 運用
- モデルの切替は環境変数で行い、コード変更不要。
- 将来的に Sonnet 等へ拡張する場合は、ARN を追加し同様に最小権限で付与。
