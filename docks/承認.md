認証は、（A）**スプレッドシート上での承認**＋（B）**AWS側での安全な書込・公開**の2レイヤで設計します。

---

# 1) 誰が承認する？（ロール）

* **Viewer（お客さま）**：Webメニューを見るだけ（匿名）
* **Editor（店舗スタッフ）**：シート編集と承認可（Googleアカウントで認証）
* **Admin（あなた）**：全権（GAS/インフラ設定）

> 承認は **Editor/Admin のみ**。お客さまには一切認証や承認は求めません。

---

# 2) 承認フローの全体像（安全設計）

```
[AI/Lambdaが候補生成] → S3(非公開 "staging") に画像保存
    ↓ URLをGASへ返す（署名URL or 内部キー）
[Google Sheet]
  - aiStatus = NeedsReview
  - aiSuggestedDescription / aiSuggestedImageUrl に候補
  - 承認列（DataValidation: Approved/Rejected）
    ↓（Editorが承認）
onEditでGASが検知
    ↓
GASがAWSのWebhookへ（HMAC署名つき）
    ↓
Lambdaが S3 "staging" → "public" へコピー（ACL/Cache付与）
    ↓
menu.json更新・CloudFront無効化(必要時)
    ↓
公開反映
```

---

# 3) 認証・認可の具体策（要点だけ）

## (A) スプレッドシート側（人の認証）

* **Googleアカウントで認証**（共有設定：編集者＝店舗スタッフのアカウントのみ）
* **承認列**は**データ検証**で「Approved/Rejected/—」のプルダウンに限定
* **保護範囲**（Protected range）で承認列だけを編集権限者に制限可（誤編集防止）
* （任意）**GASサイドバー**で候補画像プレビュー→承認ボタン

## (B) GAS → AWS（Webhook 認証）

* **HMAC署名**：

  * ヘッダ：`X-Timestamp`, `X-Signature`
  * 署名：`hex(hmac_sha256(secret, timestamp + "." + body))`
  * サーバで**±5分許容＋nonce**でリプレイ防止
* **プリサインドURL**でS3書込（GASに長期AWS鍵を置かない）
* **API Gateway + Lambda**は**IAM最小権限**（対象S3のみPut/Get/List）

## (C) AWS 内（モデル・画像・公開）

* **Bedrock呼び出し**：**IAMロール**で許可（APIキー不要）
* 画像はまず **S3「staging」(非公開/短期キャッシュ)** へ保存
  → **承認後に「public」(公開/長期キャッシュ)** へ**サーバ側コピー**（GASからは直接publicに置かない）
* 公開反映は `menu.json` 更新と必要なら **CloudFront Invalidation**（`/menu.json` だけ）

---

# 4) シート列のサンプル（承認ワークフロー用）

| 列名                       | 例                                       | 説明                       |
| ------------------------ | --------------------------------------- | ------------------------ |
| `aiStatus`               | `NeedsReview`/`Approved`/`Rejected`     | 候補のレビュー状態                |
| `aiSuggestedDescription` | `爽やかで〜`                                 | AIが提案                    |
| `aiSuggestedImageUrl`    | `s3://bucket/staging/xxxx.jpg` or 署名URL | AI/スクレイパが取得              |
| `approveFlag`            | `Approved`/`Rejected`/`-`               | **人が選ぶ（データ検証）**          |
| `approvedBy`             | `user@example.com`                      | GASが onEdit で書込          |
| `approvedAt`             | `2025-10-05T12:34:56+09:00`             | GASが onEdit で書込          |
| `imageUrl`               | `https://cdn/.../public/xxxx.jpg`       | **承認後にLambdaが確定URLを書戻し** |
| `description`            | 最終採用文                                   | **承認後に確定**               |

> 運用：`approveFlag=Approved` になったら **GAS→Webhook** → Lambda側で
>
> 1. staging→publicコピー
> 2. `imageUrl` を確定URLに更新
> 3. `description` に `aiSuggestedDescription` を反映
> 4. `aiStatus=Approved` に変更
>    までを一括で実施

---

# 5) 認証まわりの“やってはいけない”例

* GASに**AWS長期クレデンシャル**を直書き（NG）
  → 常に**プリサインドURL** or **API Gateway**経由で
* いきなり `public` に画像保存（NG）
  → **staging → 承認 → public** の二段階
* Webhookを**無署名**で公開（NG）
  → HMAC検証＋時刻制限＋nonce必須

---

# 6) オプション：承認UIをシート以外にする場合

* **管理用ミニダッシュボード**（Next.js 製・社内向け）

  * **Cognito + Google IdP** でログイン（スタッフのみ）
  * 候補画像プレビュー→承認→Lambda API 呼び出し
  * シートは**単なるマスター**として読み書き（AppScript不要にもできる）
* **Google Chat / メール承認**

  * GASから承認リンクを送信（**署名付き一回限りURL**）。クリック＝承認
  * 小規模運用で便利（ただしリンク漏洩対策は厳格に）

---

# 7) シーケンス（承認時）

```
Editor(人)
  → [Google Sheet 承認列=Approved]
    → GAS onEdit
      → (認可) シート編集者のメールを取得
      → (署名) X-Timestamp/X-Signature 付与
      → POST /webhook (API Gateway)
        → Lambda: 署名検証・権限チェック
        → S3: staging → public にコピー
        → menu.json 更新（必要なら makers.json も）
        → CloudFront Invalidate(/menu.json)
      → （任意）GASが行に approvedBy/At, imageUrl を反映
```

---

## まとめ

* **承認は店舗側スタッフのGoogleアカウントで**。お客さまに認証は不要。
* **GAS→AWSはHMAC署名**、**画像はstaging→承認後public**、**menu.json更新で公開**。
* これで「レビュー付きで書戻し」「画像は承認後に公開」に対する認証・認可の筋が通ります。
